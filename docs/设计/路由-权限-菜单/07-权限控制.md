# 权限控制

> 太行视觉AI平台 - 权限码系统与权限检查机制

---

## 目录

- [1. 权限码格式](#1-权限码格式)
- [2. 权限检查](#2-权限检查)
- [3. 权限 API](#3-权限-api)
- [4. 使用场景](#4-使用场景)

---

## 1. 权限码格式

### 1.1 权限码命名规范

```
格式: 模块:功能:操作

示例:
monitor:realtime:page        # 监控-实时监控-页面权限
monitor:alarm:handle        # 监控-告警-处理
monitor:alarm:delete        # 监控-告警-删除
system:user:add             # 系统-用户-添加
system:user:edit            # 系统-用户-编辑
system:user:delete          # 系统-用户-删除
system:user:page            # 系统-用户-页面权限
skill:device:add            # 技能-设备-添加
skill:device:edit           # 技能-设备-编辑
skill:device:delete         # 技能-设备-删除
rbac:role:assign            # RBAC-角色-分配
```

### 1.2 权限码层级

| 层级 | 说明 | 示例 |
|-----|------|------|
| **模块** | 功能模块 | `monitor`, `system`, `skill`, `rbac` |
| **功能** | 具体功能 | `realtime`, `user`, `device` |
| **操作** | 操作类型 | `page`, `add`, `edit`, `delete`, `handle` |

### 1.3 操作类型说明

| 操作 | 说明 | 示例 |
|-----|------|------|
| `page` | 页面访问权限 | `monitor:realtime:page` |
| `add` | 添加权限 | `system:user:add` |
| `edit` | 编辑权限 | `system:user:edit` |
| `delete` | 删除权限 | `system:user:delete` |
| `view` | 查看权限 | `system:user:view` |
| `handle` | 处理权限 | `monitor:alarm:handle` |
| `export` | 导出权限 | `monitor:statistics:export` |
| `assign` | 分配权限 | `rbac:role:assign` |

---

## 2. 权限检查

### 2.1 Permissions Store

**文件**: `src/stores/modules/permissions.ts`

```typescript
import { defineStore } from 'pinia'
import { ref } from 'vue'
import { StorageKey } from '@/stores/modules/storageKeys'

export const usePermissionsStore = defineStore('permissions', () => {
  // 权限码列表
  const permissions = ref<string[]>([])

  // 设置权限列表
  function setPermissions(perms: string[]) {
    permissions.value = perms
  }

  // 清除权限列表
  function clearPermissions() {
    permissions.value = []
  }

  /**
   * 检查是否有某个权限
   */
  function hasPermission(permission: string): boolean {
    return permissions.value.includes(permission)
  }

  /**
   * 检查是否有多个权限中的任意一个
   */
  function hasAnyPermission(perms: string[]): boolean {
    return perms.some(p => permissions.value.includes(p))
  }

  /**
   * 检查是否有所有指定的权限
   */
  function hasAllPermissions(perms: string[]): boolean {
    return perms.every(p => permissions.value.includes(p))
  }

  /**
   * 获取所有权限码
   */
  function getAllPermissions(): string[] {
    return permissions.value
  }

  return {
    permissions,
    setPermissions,
    clearPermissions,
    hasPermission,
    hasAnyPermission,
    hasAllPermissions,
    getAllPermissions
  }
}, {
  persist: {
    key: StorageKey.PERMISSION,  // 'taihang-permissions'
    storage: localStorage
  }
})
```

### 2.2 在组件中使用

```typescript
import { usePermissionsStore } from '@/stores'

const permissionsStore = usePermissionsStore()

// 检查单个权限
if (permissionsStore.hasPermission('monitor:realtime:page')) {
  // 有权限，显示实时监控按钮
}

// 检查多个权限（满足其一即可）
if (permissionsStore.hasAnyPermission(['system:user:add', 'system:user:edit'])) {
  // 有添加或编辑权限
}

// 检查多个权限（必须全部满足）
if (permissionsStore.hasAllPermissions(['skill:device:add', 'skill:device:edit'])) {
  // 同时有添加和编辑权限
}
```

### 2.3 在模板中使用

```vue
<template>
  <div>
    <!-- 有添加权限时显示按钮 -->
    <el-button
      v-if="permissionsStore.hasPermission('system:user:add')"
      @click="handleAdd"
    >
      添加用户
    </el-button>

    <!-- 有编辑权限时显示按钮 -->
    <el-button
      v-if="permissionsStore.hasPermission('system:user:edit')"
      @click="handleEdit"
    >
      编辑
    </el-button>

    <!-- 有删除权限时显示按钮 -->
    <el-button
      v-if="permissionsStore.hasPermission('system:user:delete')"
      type="danger"
      @click="handleDelete"
    >
      删除
    </el-button>
  </div>
</template>

<script setup lang="ts">
import { usePermissionsStore } from '@/stores'

const permissionsStore = usePermissionsStore()
</script>
```

### 2.4 权限指令（可选）

**自定义指令**：

```typescript
// src/directives/permission.ts
import type { Directive } from 'vue'
import { usePermissionsStore } from '@/stores'

export const permission: Directive = {
  mounted(el, binding) {
    const { value } = binding
    const permissionsStore = usePermissionsStore()

    if (value && !permissionsStore.hasPermission(value)) {
      // 无权限，移除元素
      el.parentNode?.removeChild(el)
    }
  }
}

// 注册指令
app.directive('permission', permission)
```

**使用指令**：

```vue
<template>
  <!-- 有权限才显示 -->
  <el-button v-permission="'system:user:add'" @click="handleAdd">
    添加用户
  </el-button>
</template>
```

---

## 3. 权限 API

### 3.1 获取权限列表

**端点**: `GET /api/v1/permissions`

**请求**：
```typescript
// 需要认证
headers: {
  Authorization: `Bearer ${token}`
}
```

**响应**：
```typescript
{
  code: 200,
  message: "成功",
  data: {
    user_id: 1,
    user_name: "admin",
    permission_codes: [
      "monitor:realtime:page",
      "monitor:alarm:handle",
      "system:user:add",
      "system:user:edit",
      "system:user:delete",
      "skill:device:add"
    ]
  }
}
```

### 3.2 API 封装

**文件**: `src/api/auth/authAPI.ts`

```typescript
/**
 * 获取当前用户权限列表
 */
async getPermissions(): Promise<UnifiedResponse<AuthPermissionsResponse>> {
  return authAxios.get('/api/v1/permissions')
}

// 响应类型
interface AuthPermissionsResponse {
  user_id: number
  user_name: string
  permission_codes: string[]
}
```

### 3.3 在登录时获取

```typescript
// Login.vue
async function login() {
  // 1. 登录获取 token
  const result = await authAPI.login({ username, password })
  tokenStore.setToken(result.data.token)

  // 2. 并行获取用户数据
  const [userInfoResult, permissionsResult, menuTreeResult] = await Promise.all([
    authAPI.getUserInfo(),
    authAPI.getPermissions(),  // ← 获取权限列表
    authAPI.getMenuTree()
  ])

  // 3. 设置权限列表
  if (permissionsResult.code === 200) {
    const perms = permissionsResult.data.permission_codes || []
    permissionsStore.setPermissions(perms)
  }

  // 4. 跳转目标页面
  router.push(redirect || '/')
}
```

---

## 4. 使用场景

### 4.1 按钮权限控制

```vue
<template>
  <div class="user-actions">
    <!-- 添加按钮 -->
    <el-button
      v-if="permissionsStore.hasPermission('system:user:add')"
      type="primary"
      @click="handleAdd"
    >
      <el-icon><Plus /></el-icon>
      添加用户
    </el-button>

    <!-- 批量删除按钮 -->
    <el-button
      v-if="permissionsStore.hasPermission('system:user:delete')"
      type="danger"
      :disabled="selectedUsers.length === 0"
      @click="handleBatchDelete"
    >
      <el-icon><Delete /></el-icon>
      批量删除
    </el-button>

    <!-- 导出按钮 -->
    <el-button
      v-if="permissionsStore.hasPermission('system:user:export')"
      @click="handleExport"
    >
      <el-icon><Download /></el-icon>
      导出
    </el-button>
  </div>
</template>
```

### 4.2 表格操作列

```vue
<template>
  <el-table :data="users">
    <el-table-column prop="user_name" label="用户名" />
    <el-table-column prop="nick_name" label="昵称" />

    <!-- 操作列 -->
    <el-table-column label="操作" width="200">
      <template #default="{ row }">
        <el-button
          v-if="permissionsStore.hasPermission('system:user:edit')"
          size="small"
          @click="handleEdit(row)"
        >
          编辑
        </el-button>

        <el-button
          v-if="permissionsStore.hasPermission('system:user:delete')"
          size="small"
          type="danger"
          @click="handleDelete(row)"
        >
          删除
        </el-button>

        <el-button
          v-if="permissionsStore.hasPermission('rbac:role:assign')"
          size="small"
          @click="handleAssignRole(row)"
        >
          分配角色
        </el-button>
      </template>
    </el-table-column>
  </el-table>
</template>
```

### 4.3 页面访问权限

```vue
<template>
  <div v-if="canAccessPage">
    <!-- 页面内容 -->
  </div>
  <div v-else class="no-permission">
    <el-empty description="您没有访问此页面的权限" />
  </div>
</template>

<script setup lang="ts">
import { usePermissionsStore } from '@/stores'

const permissionsStore = usePermissionsStore()

// 检查页面访问权限
const canAccessPage = computed(() =>
  permissionsStore.hasPermission('system:user:page')
)
</script>
```

### 4.4 功能模块权限

```vue
<template>
  <el-tabs v-model="activeTab">
    <!-- 标签页 1：需要 page 权限 -->
    <el-tab-pane
      v-if="permissionsStore.hasPermission('monitor:realtime:page')"
      label="实时监控"
      name="realtime"
    >
      <RealtimeMonitor />
    </el-tab-pane>

    <!-- 标签页 2：需要 page 权限 -->
    <el-tab-pane
      v-if="permissionsStore.hasPermission('monitor:statistics:page')"
      label="统计分析"
      name="statistics"
    >
      <StatisticsAnalysis />
    </el-tab-pane>

    <!-- 标签页 3：需要 page 权限 -->
    <el-tab-pane
      v-if="permissionsStore.hasPermission('monitor:warning:page')"
      label="预警档案"
      name="warning"
    >
      <WarningArchives />
    </el-tab-pane>
  </el-tabs>
</template>
```

### 4.5 复杂权限组合

```vue
<template>
  <div>
    <!-- 有添加或编辑权限之一即可 -->
    <el-button
      v-if="permissionsStore.hasAnyPermission(['system:user:add', 'system:user:edit'])"
      @click="handleSave"
    >
      保存
    </el-button>

    <!-- 需要同时有查看和编辑权限 -->
    <el-button
      v-if="permissionsStore.hasAllPermissions(['skill:device:view', 'skill:device:edit'])"
      @click="handleEdit"
    >
      编辑技能
    </el-button>

    <!-- 管理员专属 -->
    <el-button
      v-if="permissionsStore.hasPermission('system:admin')"
      type="danger"
      @click="handleDanger"
    >
      危险操作
    </el-button>
  </div>
</template>
```

---

## 5. 权限与路由

### 5.1 路由级权限

**当前实现**：路由守卫只检查认证状态，不检查细粒度权限。

```typescript
router.beforeEach((to, _from, next) => {
  // 只检查 token，不检查具体权限
  const token = getTokenFromStorage()
  if (!token) {
    next({ path: '/login' })
    return
  }
  next()
})
```

**原因**：
- 路由守卫是全局的，细粒度权限检查在组件内更灵活
- 用户无权限的页面访问后显示提示，体验更好
- 简化守卫逻辑，提高性能

### 5.2 组件级权限

**推荐方式**：在页面组件内检查权限。

```vue
<script setup lang="ts">
import { usePermissionsStore } from '@/stores'
import { onMounted } from 'vue'

const permissionsStore = usePermissionsStore()

onMounted(() => {
  // 检查页面访问权限
  if (!permissionsStore.hasPermission('system:user:page')) {
    ElMessage.warning('您没有访问此页面的权限')
    router.back()
  }
})
</script>
```

---

## 6. 权限数据流

### 6.1 完整流程

```
登录成功
    │
    ▼
调用 GET /api/v1/permissions
    │
    ▼
后端返回权限码列表
{ permission_codes: [...] }
    │
    ▼
permissionsStore.setPermissions(perms)
    │
    ├─→ Store 状态更新
    │
    └─→ 持久化插件自动写入 localStorage
            │
            ▼
        taihang-permissions = [...]
```

### 6.2 权限检查流程

```
组件调用 hasPermission('system:user:add')
    │
    ▼
permissionsStore.permissions.includes('system:user:add')
    │
    ├─→ true  → 有权限
    │
    └─→ false → 无权限
```

---

## 7. 权限设计原则

| 原则 | 说明 |
|-----|------|
| **最小权限** | 默认无权限，明确授予所需权限 |
| **细粒度** | 按功能模块和操作类型细分权限 |
| **命名规范** | 统一使用 `模块:功能:操作` 格式 |
| **前后端一致** | 权限码前后端保持一致 |
| **动态加载** | 权限随用户角色动态变化 |
| **缓存复用** | 权限列表缓存到 localStorage，避免重复请求 |

---

## 8. 常见问题

### 8.1 权限检查不生效

**可能原因**：
1. `permissionsStore` 未正确初始化
2. 权限码名称不匹配
3. Store 中没有权限数据

**排查**：
```typescript
console.log('所有权限:', permissionsStore.getAllPermissions())
console.log('是否有权限:', permissionsStore.hasPermission('system:user:add'))
```

### 8.2 权限未及时更新

**原因**：权限列表缓存，角色变更后需要重新登录

**解决**：
1. 角色变更后提示用户重新登录
2. 或提供"刷新权限"功能，重新调用 API

### 8.3 权限码命名不一致

**原则**：
- 前后端使用相同的权限码规范
- 后端返回的权限码应与前端检查的完全一致
- 建议在后端维护权限码常量定义

---

**下一步**: 阅读 [关键文件索引](./08-关键文件索引.md) 了解核心文件位置
