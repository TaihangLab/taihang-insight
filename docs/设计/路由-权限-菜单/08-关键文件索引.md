# 关键文件索引

> 太行视觉AI平台 - 路由与权限系统核心文件位置与说明

---

## 目录

- [1. 核心 Store 模块](#1-核心-store-模块)
- [2. 路由相关](#2-路由相关)
- [3. 登录相关](#3-登录相关)
- [4. 菜单相关](#4-菜单相关)
- [5. API 服务](#5-api-服务)
- [6. 类型定义](#6-类型定义)

---

## 1. 核心 Store 模块

### 1.1 Store 文件列表

| 文件 | 路径 | 说明 | localStorage Key |
|-----|------|------|------------------|
| **Token** | `src/stores/modules/token.ts` | Token 管理 | `taihang-token` |
| **UserInfo** | `src/stores/modules/userInfo.ts` | 用户信息 | `taihang-user-info` |
| **Permissions** | `src/stores/modules/permissions.ts` | 权限列表 | `taihang-permissions` |
| **Menus** | `src/stores/modules/menus.ts` | 菜单树 | `taihang-menus` |
| **StorageKeys** | `src/stores/modules/storageKeys.ts` | StorageKey 枚举 | - |

### 1.2 Store 导入

**文件**: `src/stores/index.ts`

```typescript
export { useTokenStore } from './modules/token'
export { useUserInfoStore } from './modules/userInfo'
export { usePermissionsStore } from './modules/permissions'
export { useMenusStore } from './modules/menus'

// 便捷导入
export function useStores() {
  return {
    token: useTokenStore(),
    userInfo: useUserInfoStore(),
    permissions: usePermissionsStore(),
    menus: useMenusStore()
  }
}
```

---

## 2. 路由相关

### 2.1 路由配置

| 文件 | 路径 | 说明 |
|-----|------|------|
| **路由配置** | `src/router/index.ts` | 路由定义、动态路由生成、路由守卫 |
| **Layout** | `src/layout/index.vue` | 主布局组件 |
| **侧边栏** | `src/layout/SideMenu.vue` | 侧边栏菜单组件 |
| **顶部导航** | `src/layout/UiHeader.vue` | 顶部导航栏 |

### 2.2 路由配置详解

**src/router/index.ts** (约 320 行)

```typescript
// 主要内容：
1. componentMap - 路由到组件的映射
2. constantRoutes - 基础路由配置
3. setupAsyncRoutes() - 动态路由生成函数
4. resetAsyncRoutes() - 路由重置函数
5. router.beforeEach - 全局前置守卫
6. router.afterEach - 全局后置钩子
```

**关键函数**：

| 函数 | 说明 | 参数 |
|-----|------|------|
| `setupAsyncRoutes(menuItems)` | 根据菜单树动态生成路由 | 菜单项数组 |
| `resetAsyncRoutes()` | 重置动态路由标记 | 无 |
| `getTokenFromStorage()` | 从 localStorage 读取 token | 无 |

---

## 3. 登录相关

### 3.1 登录文件

| 文件 | 路径 | 说明 |
|-----|------|------|
| **登录页** | `src/pages/commons/Login.vue` | 登录页面组件 |
| **认证 API** | `src/api/auth/authAPI.ts` | 认证 API 实现 |
| **认证实例** | `src/api/auth/instance.ts` | Axios 实例配置 |

### 3.2 Login.vue 结构

```vue
<template>
  <!-- Logo 区域 -->
  <div class="login-header">...</div>

  <!-- 租户选择 -->
  <el-select v-model="selectedTenant">...</el-select>

  <!-- 表单 -->
  <el-form>
    <el-input v-model="username" />
    <el-input v-model="password" type="password" />
    <el-button @click="login">登录</el-button>
  </el-form>
</template>

<script setup lang="ts">
// 登录流程：
1. 表单验证
2. 调用 authAPI.login()
3. 设置 Token
4. 并行获取用户数据 (Promise.all)
5. 设置 Store 数据
6. 等待持久化
7. 跳转目标页面
</script>
```

### 3.3 认证 API

**src/api/auth/authAPI.ts**

```typescript
// 主要 API：
login(data)          → POST /api/v1/login
getUserInfo()        → GET /api/v1/user/info
getPermissions()     → GET /api/v1/permissions
getMenuTree()        → GET /api/v1/menu/tree
```

---

## 4. 菜单相关

### 4.1 菜单组件

| 文件 | 路径 | 说明 |
|-----|------|------|
| **侧边栏** | `src/layout/SideMenu.vue` | 侧边栏菜单容器 |
| **动态菜单** | `src/components/common/DynamicMenu.vue` | 动态菜单组件（可选） |
| **菜单项** | `src/components/common/MenuItem.vue` | 菜单项递归组件（可选） |

### 4.2 SideMenu.vue 结构

```vue
<template>
  <div class="side-menu-container">
    <!-- Logo 区域 -->
    <div class="logo-section">...</div>

    <!-- 折叠按钮 -->
    <div class="collapse-trigger">...</div>

    <!-- 菜单区域 -->
    <el-menu router>
      <template v-for="menuItem in menuTree">
        <!-- 有子菜单 -->
        <el-sub-menu v-if="menuItem.children">...</el-sub-menu>

        <!-- 无子菜单 -->
        <el-menu-item v-else>...</el-menu-item>
      </template>
    </el-menu>
  </div>
</template>

<script setup lang="ts">
// 主要内容：
1. menuTree - 从 menusStore 获取
2. activeMenu - 当前激活菜单
3. isCollapsed - 折叠状态
4. iconMap - 图标映射
5. toggleCollapse() - 切换折叠
</script>
```

---

## 5. API 服务

### 5.1 认证服务

| 文件 | 路径 | 说明 |
|-----|------|------|
| **authAPI** | `src/api/auth/authAPI.ts` | 认证 API 封装 |
| **instance** | `src/api/auth/instance.ts` | Axios 实例配置 |

### 5.2 instance.ts 结构

```typescript
import axios from 'axios'
import { ElMessage } from 'element-plus'

const authAxios = axios.create({
  baseURL: import.meta.env.VITE_API_BASE_URL,
  timeout: 10000
})

// 请求拦截器
authAxios.interceptors.request.use(
  (config) => {
    const tokenStore = useTokenStore()
    if (tokenStore.token) {
      config.headers.Authorization = `Bearer ${tokenStore.token}`
    }
    return config
  }
)

// 响应拦截器
authAxios.interceptors.response.use(
  (response) => response,
  (error) => {
    if (error.response?.status === 401) {
      ElMessage.error('登录已过期')
      tokenStore.clearToken()
      window.location.href = '/login'
    }
    return Promise.reject(error)
  }
)
```

---

## 6. 类型定义

### 6.1 类型文件

| 文件 | 路径 | 说明 |
|-----|------|------|
| **auth 类型** | `src/types/auth.d.ts` | 认证相关类型定义 |
| **router 类型** | `src/router/types.ts` | 路由相关类型（可选） |

### 6.2 auth.d.ts 结构

```typescript
/** 用户信息 */
interface UserInfo {
  id?: number
  user_id?: number
  username?: string
  user_name?: string
  nick_name?: string
  email?: string
  phone?: string
  avatar?: string
  tenantId?: number
  tenant_id?: number
  dept_id?: number
  position_id?: number
  status?: number
  gender?: string
}

/** 菜单项 */
interface MenuItem {
  id: number
  menu_name?: string
  permission_name?: string
  name?: string
  menu_type?: string | number
  permission_type?: string | number
  type?: string | number
  icon?: string
  path?: string
  sort_order?: number
  status?: number
  visible?: boolean
  children?: MenuItem[]
}

/** API 响应 */
interface UnifiedResponse<T = any> {
  code: number
  message: string
  data: T
}

/** 登录响应 */
interface LoginResponse {
  token: string
}

/** 用户信息响应 */
interface UserInfoResponse {
  user_id: number
  user_name: string
  nick_name?: string
  email?: string
  phone?: string
  avatar?: string
  tenant_id: number
  dept_id?: number
  position_id?: number
  status?: number
  gender?: string
}

/** 权限列表响应 */
interface AuthPermissionsResponse {
  user_id: number
  user_name: string
  permission_codes: string[]
}

/** 菜单树响应 */
interface MenuTreeResponse {
  user_id: number
  user_name: string
  menu_tree: MenuItem[]
}
```

---

## 7. 布局组件

### 7.1 Layout 结构

```
src/layout/
├── index.vue           # 主布局容器
├── SideMenu.vue        # 侧边栏
├── UiHeader.vue        # 顶部导航
└── styles/             # 布局样式
```

### 7.2 index.vue 结构

```vue
<template>
  <div class="layout-container">
    <!-- 侧边栏 -->
    <SideMenu
      :collapsed="sidebarCollapsed"
      @collapse-change="handleCollapseChange"
    />

    <!-- 主内容区 -->
    <div class="main-container">
      <!-- 顶部导航 -->
      <UiHeader />

      <!-- 页面内容 -->
      <div class="content-area">
        <router-view />
      </div>
    </div>
  </div>
</template>
```

---

## 8. 应用入口

### 8.1 main.ts

**文件**: `src/main.ts`

```typescript
import { createApp } from 'vue'
import { createPinia } from 'pinia'
import piniaPluginPersistedstate from 'pinia-plugin-persistedstate'
import App from './App.vue'
import router from './router'

const app = createApp(App)

// Pinia
const pinia = createPinia()
pinia.use(piniaPluginPersistedstate)
app.use(pinia)

// Router
app.use(router)

// 挂载应用
app.mount('#app')

// 初始化菜单和动态路由
// (在应用启动后执行)
```

---

## 9. 配置文件

### 9.1 环境配置

| 文件 | 路径 | 说明 |
|-----|------|------|
| **开发环境** | `.env.development` | 开发环境变量 |
| **生产环境** | `.env.production` | 生产环境变量 |

**.env.development**:
```bash
VITE_API_BASE_URL=http://localhost:8000
```

**.env.production**:
```bash
VITE_API_BASE_URL=https://api.production.com
```

### 9.2 Vite 配置

**文件**: `vite.config.ts`

```typescript
export default defineConfig({
  plugins: [vue()],
  resolve: {
    alias: {
      '@': path.resolve(__dirname, 'src'),
      '@static': path.resolve(__dirname, 'static')
    }
  },
  server: {
    port: 4000
  }
})
```

---

## 10. 文件依赖关系

### 10.1 数据流向

```
Login.vue
    │
    ├─→ authAPI.ts
    │       │
    │       └─→ instance.ts (Axios)
    │
    ├─→ Token Store
    ├─→ UserInfo Store
    ├─→ Permissions Store
    └─→ Menus Store
            │
            ▼
      router/index.ts
            │
            ├─→ setupAsyncRoutes()
            └─→ beforeEach()
                    │
                    ▼
            SideMenu.vue
```

### 10.2 Store 依赖

```
Pinia Instance
    │
    ├─→ token.ts
    ├─→ userInfo.ts
    ├─→ permissions.ts
    └─→ menus.ts
        │
        ▼
    pinia-plugin-persistedstate
        │
        ▼
    localStorage
```

---

## 11. 快速查找

### 11.1 按功能查找

| 功能 | 文件 | 行号参考 |
|-----|------|---------|
| **登录** | `src/pages/commons/Login.vue` | `login()` 函数 |
| **Token 存储** | `src/stores/modules/token.ts` | `setToken()` |
| **动态路由** | `src/router/index.ts` | `setupAsyncRoutes()` |
| **路由守卫** | `src/router/index.ts` | `beforeEach()` |
| **菜单渲染** | `src/layout/SideMenu.vue` | `<el-menu>` 部分 |
| **权限检查** | `src/stores/modules/permissions.ts` | `hasPermission()` |
| **API 请求** | `src/api/auth/authAPI.ts` | 各 API 函数 |

### 11.2 按关键词查找

```bash
# 查找登录相关
grep -r "login" src/pages/commons/

# 查找路由配置
grep -r "componentMap" src/router/

# 查找 Store 定义
grep -r "defineStore" src/stores/modules/

# 查找权限检查
grep -r "hasPermission" src/stores/
```

---

## 12. 修改建议

### 12.1 添加新页面

1. 创建页面组件
2. 在 `componentMap` 中添加映射
3. 后端添加菜单配置

### 12.2 添加新权限

1. 确定权限码格式（模块:功能:操作）
2. 后端分配权限给角色
3. 前端使用 `hasPermission()` 检查

### 12.3 修改菜单

1. 修改 `SideMenu.vue` 样式
2. 调整图标映射 `iconMap`
3. 更新菜单过滤逻辑

---

**下一步**: 阅读 [常见问题](./09-常见问题.md) 了解常见问题与解决方案
