# 动态路由系统

> 太行视觉AI平台 - 基于菜单树的动态路由生成系统

---

## 目录

- [1. 路由配置](#1-路由配置)
- [2. 组件映射](#2-组件映射)
- [3. 动态路由生成](#3-动态路由生成)
- [4. 路由结构](#4-路由结构)
- [5. 首页配置](#5-首页配置)

---

## 1. 路由配置

### 1.1 路由文件位置

**文件**: `src/router/index.ts`

### 1.2 路由配置结构

```typescript
import { createRouter, createWebHashHistory, type RouteRecordRaw } from 'vue-router'
import Layout from '@/layout/index.vue'

// ========== 懒加载组件映射 ==========
const componentMap: Record<string, () => Promise<any>> = {
  // 见下一节完整定义
}

// ========== 基础路由 ==========
const constantRoutes: RouteRecordRaw[] = [
  // 登录页
  {
    path: '/login',
    name: 'Login',
    component: () => import('../pages/commons/Login.vue'),
    meta: { title: '登录' }
  },

  // 主布局路由
  {
    path: '/',
    name: 'Layout',
    component: Layout,
    redirect: '/visual',  // ← 默认首页
    children: []         // ← 动态路由会添加到这里
  }
]

// ========== 创建路由实例 ==========
const router = createRouter({
  history: createWebHashHistory(),
  routes: constantRoutes
})

export default router
```

---

## 2. 组件映射

### 2.1 componentMap 定义

**文件**: `src/router/index.ts`

```typescript
/**
 * 业务路由组件映射
 * 路由路径 → 懒加载组件函数
 */
const componentMap: Record<string, () => Promise<any>> = {
  // ========== 可视化中心 ==========
  '/visualCenter': () => import('../pages/center/visualCenter.vue'),
  '/visual': () => import('../pages/center/visualCenter.vue'),
  '/visual/algorithm': () => import('../pages/center/algorithmInference.vue'),
  '/algorithmInference': () => import('../pages/center/algorithmInference.vue'),
  '/visual/park': () => import('../components/visionAI/ivisualCenter/parkManagement.vue'),
  '/visualCenter/parkManagement': () => import('../components/visionAI/ivisualCenter/parkManagement.vue'),

  // ========== 监控预警 ==========
  '/monitoring/realtime': () => import('../components/visionAI/monitoringWarning/realTimeMonitoring.vue'),
  '/monitoring/statistics': () => import('../components/visionAI/monitoringWarning/statisticsAnalysis.vue'),
  '/monitoring/warningArchive': () => import('../components/visionAI/monitoringWarning/warningArchives.vue'),
  '/monitoring/warningManage': () => import('../components/visionAI/monitoringWarning/warningManagement.vue'),
  '/monitoring/reviewRecords': () => import('../components/visionAI/monitoringWarning/reviewRecords.vue'),
  '/monitoring/intelligentReview': () => import('../components/visionAI/monitoringWarning/intelligentReview.vue'),
  '/monitoring/warnings': () => import('../components/visionAI/monitoringWarning/warningArchives.vue'),
  '/monitoring/review': () => import('../components/visionAI/monitoringWarning/reviewRecords.vue'),
  '/monitoring/intelligent-review': () => import('../components/visionAI/monitoringWarning/intelligentReview.vue'),

  // ========== 设备管理 ==========
  '/deviceManage/camera': () => import('../components/visionAI/deviceManagement/camera.vue'),
  '/deviceManage/cameraManagement': () => import('../components/visionAI/deviceManagement/CameraManagementMain.vue'),
  '/deviceManage/localVideo': () => import('../components/visionAI/deviceManagement/localVideo.vue'),
  '/devices/cameras': () => import('../components/visionAI/deviceManagement/camera.vue'),
  '/devices/cameras-main': () => import('../components/visionAI/deviceManagement/CameraManagementMain.vue'),
  '/devices/local-video': () => import('../components/visionAI/deviceManagement/localVideo.vue'),

  // ========== 模型管理 ==========
  '/modelManage/modelList': () => import('../components/visionAI/modelManagement/modelList.vue'),
  '/models': () => import('../components/visionAI/modelManagement/modelList.vue'),
  '/models/list': () => import('../components/visionAI/modelManagement/modelList.vue'),

  // ========== 技能管理 ==========
  '/skillManage/deviceSkills': () => import('../components/visionAI/skillManagement/deviceSkills.vue'),
  '/skillManage/multimodalLlmSkills': () => import('../components/visionAI/skillManagement/multimodalLlmSkills.vue'),
  '/skillManage/multimodalReview': () => import('../components/visionAI/skillManagement/multimodalReview.vue'),
  '/skills': () => import('../components/visionAI/skillManagement/deviceSkills.vue'),
  '/skills/device': () => import('../components/visionAI/skillManagement/deviceSkills.vue'),
  '/skills/multimodal-llm': () => import('../components/visionAI/skillManagement/multimodalLlmSkills.vue'),
  '/skills/multimodal-review': () => import('../components/visionAI/skillManagement/multimodalReview.vue'),

  // ========== 智能控制 ==========
  '/intelligentControl/logRecord': () => import('../components/visionAI/smartControl/logRecords.vue'),
  '/control': () => import('../components/visionAI/smartControl/logRecords.vue'),
  '/control/logs': () => import('../components/visionAI/smartControl/logRecords.vue'),

  // ========== 边缘管理 ==========
  '/edgeManage/edgeServer': () => import('../components/visionAI/edgeManagement/edgeServer.vue'),
  '/edgeManage/edgeBox': () => import('../components/visionAI/edgeManagement/edgeBox.vue'),
  '/edge': () => import('../components/visionAI/edgeManagement/edgeServer.vue'),
  '/edge/servers': () => import('../components/visionAI/edgeManagement/edgeServer.vue'),
  '/edge/boxes': () => import('../components/visionAI/edgeManagement/edgeBox.vue'),

  // ========== 系统管理 ==========
  '/systemManage/appSettings': () => import('../pages/system/applicationSettings.vue'),
  '/systemManage/tenantManagement': () => import('../pages/system/tenantManagement.vue'),
  '/systemManage/userManagement': () => import('../pages/system/userManagement.vue'),
  '/systemManage/roleManagement': () => import('../pages/system/roleManagement.vue'),
  '/systemManage/roleAssignment/:userId/:user_name': () => import('../pages/system/components/role/RoleUserAssignmentPage.vue'),
  '/visionAI/systemManagement/userAssignment': () => import('../pages/system/components/user/UserAssignmentPage.vue'),
  '/systemManage/departmentManagement': () => import('../pages/system/departmentManagement.vue'),
  '/systemManage/positionManagement': () => import('../pages/system/positionManagement.vue'),
  '/systemManage/profile': () => import('../pages/system/profile.vue'),
  '/systemManage/knowledgeBase': () => import('../pages/system/knowledgeBase.vue'),
  '/system/knowledge-detail': () => import('../pages/system/knowledgeBaseDetail.vue'),
  '/systemManage/permissionManagement': () => import('../pages/system/permissionManagement.vue')
}

export { componentMap }
```

### 2.2 映射原则

| 原则 | 说明 |
|-----|------|
| **多路径支持** | 同一组件可映射多个路径（兼容后端不同返回） |
| **懒加载** | 所有组件使用动态 import，按需加载 |
| **路径规范** | 遵循 `/模块/功能` 的层级结构 |
| **类型安全** | 使用 `Record<string, () => Promise<any>>` 类型 |

---

## 3. 动态路由生成

### 3.1 setupAsyncRoutes 函数

**文件**: `src/router/index.ts`

```typescript
// 动态路由是否已添加的标记
let asyncRoutesAdded = false

/**
 * 动态生成并添加业务路由
 * 根据后端返回的菜单树生成路由配置并添加到路由器
 * @param menuItems 后端返回的菜单树
 */
export function setupAsyncRoutes(menuItems: any[]): void {
  // 避免重复添加
  if (asyncRoutesAdded) {
    return
  }

  const routes: RouteRecordRaw[] = []

  /**
   * 递归处理菜单树
   */
  function processMenuItems(items: any[]) {
    for (const item of items) {
      // 兼容后端不同字段名
      const menuName = item.menu_name || item.permission_name || item.name
      const menuType = item.menu_type || item.permission_type || item.type
      const path = item.path

      // 只处理 menu 类型的菜单项
      // menu_type 可能是: 'menu', 'folder', 'button' 或数字 1, 2, 3
      const isMenu = menuType === 'menu' || menuType === 1 || (!menuType && path)

      if (isMenu && path) {
        // 在 componentMap 中查找对应组件
        const component = componentMap[path]

        if (!component) {
          console.warn(`⚠️ 路径 "${path}" (${menuName}) 没有对应的组件，跳过`)
        } else {
          // 创建路由配置
          const route: RouteRecordRaw = {
            path: path,
            name: String(item.id),
            component,
            meta: {
              title: menuName,
              icon: item.icon
            }
          }
          routes.push(route)
        }
      }

      // 递归处理子菜单
      if (item.children?.length) {
        processMenuItems(item.children)
      }
    }
  }

  // 开始处理菜单树
  processMenuItems(menuItems)

  // 添加所有动态路由到 Layout 下
  routes.forEach(route => {
    router.addRoute('Layout', route)
  })

  asyncRoutesAdded = true
}
```

### 3.2 路由生成流程图

```
┌─────────────────────────────────────────────────────────────────┐
│                   后端返回菜单树 (menuTree)                      │
│  [                                                              │
│    {                                                            │
│      id: 1, menu_name: "监控预警", menu_type: "folder",         │
│      children: [                                                │
│        { id: 11, menu_name: "实时监控", menu_type: "menu",      │
│          path: "/monitoring/realtime" }                        │
│      ]                                                          │
│    }                                                            │
│  ]                                                              │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│              调用 setupAsyncRoutes(menuTree)                    │
│              递归遍历菜单树                                      │
└────────────────────────────┬────────────────────────────────────┘
                             │
                    ┌────────┴────────┐
                    │                 │
                    ▼                 ▼
            ┌───────────────┐   ┌──────────────┐
            │ menu_type =   │   │ menu_type =   │
            │ 'menu' / 1    │   │ 其他          │
            └───────────────┘   └──────────────┘
                    │                 │
                    ▼                 │
            ┌───────────────┐         │
            │ 检查 path 字段 │         │
            └───────────────┘         │
                    │                 │
           ┌────────┴────────┐        │
           │                 │        │
          有 path          无 path     │
           │                 │        │
           ▼                 ▼        │
   ┌──────────────┐   ┌──────────┐   │
   │componentMap  │   │ 跳过该项  │   │
   │ 查找组件     │   └──────────┘   │
   └──────────────┘                   │
           │                          │
   ┌───────┴────────┐                 │
   │                │                 │
   ▼                ▼                 │
找到组件        未找到组件            │
   │                │                 │
   ▼                ▼                 │
创建路由    ⚠️ console.warn          │
   │                                  │
   ▼                                  │
添加到 routes[]                       │
   │                                  │
   └──────────────────┬───────────────┘
                      │
                      ▼
         ┌────────────────────────────┐
         │  routes.forEach(route => { │
         │    router.addRoute(        │
         │      'Layout',             │
         │      route                 │
         │    )                       │
         │  })                        │
         └────────────────────────────┘
                      │
                      ▼
         ┌────────────────────────────┐
         │   动态路由已添加到 Layout   │
         └────────────────────────────┘
```

### 3.3 菜单项类型判断

| menu_type 值 | 类型 | 处理方式 |
|-------------|------|---------|
| `'menu'` 或 `1` | 菜单 | 生成路由 |
| `'folder'` 或 `2` | 文件夹 | 递归处理子菜单 |
| `'button'` 或 `3` | 按钮 | 跳过（不生成路由） |
| `undefined` + 有 `path` | 兼容模式 | 生成路由 |

---

## 4. 路由结构

### 4.1 完整路由树

```
/ (根路径，重定向到 /visual)
├── /login                         # 登录页（白名单）
├── /test                          # 测试页（白名单）
├── /play/wasm/:url               # Wasm 播放器（白名单）
├── /play/rtc/:url                # RTC 播放器（白名单）
├── /gbRecordDetail/:deviceId/:channelId/  # 国标录像详情（白名单）
├── /cloudRecordDetail/:app/:stream       # 云录像详情（白名单）
│
└── / (Layout 布局)
    ├── /visual                    # 可视中心 [默认首页]
    ├── /algorithmInference        # 算法推理平台
    │
    ├── /monitoring/*              # 监控预警（动态生成）
    │   ├── /monitoring/realtime          # 实时监控
    │   ├── /monitoring/statistics       # 统计分析
    │   ├── /monitoring/warningArchive   # 预警档案
    │   ├── /monitoring/warningManage    # 预警管理
    │   └── /monitoring/intelligentReview # 智能复判
    │
    ├── /deviceManage/*            # 设备管理（动态生成）
    │   ├── /deviceManage/camera          # 摄像头
    │   └── /deviceManage/localVideo      # 本地视频
    │
    ├── /modelManage/*              # 模型管理（动态生成）
    │   └── /modelManage/modelList        # 模型列表
    │
    ├── /skillManage/*              # 技能管理（动态生成）
    │   ├── /skillManage/deviceSkills         # 视觉模型技能
    │   ├── /skillManage/multimodalLlmSkills  # 多模态大模型技能
    │   └── /skillManage/multimodalReview     # 多模态大模型复判
    │
    ├── /edge/*                     # 边缘管理（动态生成）
    │   ├── /edge/servers    # 边缘服务器
    │   └── /edge/boxes      # 边缘盒子
    │
    └── /systemManage/*             # 系统管理（动态生成）
        ├── /systemManage/appSettings          # 应用设置
        ├── /systemManage/tenantManagement     # 租户管理
        ├── /systemManage/userManagement       # 用户管理
        ├── /systemManage/roleManagement       # 角色管理
        ├── /systemManage/permissionManagement # 权限管理
        ├── /systemManage/departmentManagement # 部门管理
        ├── /systemManage/positionManagement   # 岗位管理
        ├── /systemManage/profile              # 个人中心
        └── /systemManage/knowledgeBase        # 知识库管理
```

### 4.2 路由层级关系

```
Vue Router
├── constantRoutes (静态路由，定义文件)
│   ├── /login
│   ├── /test
│   ├── /play/* (播放器)
│   └── / (Layout)
│       └── children: [] ← 动态路由添加到这里
│
└── asyncRoutes (动态路由，菜单生成)
    └── 添加到 Layout.children
```

### 4.3 路由元信息

```typescript
{
  path: '/monitoring/realtime',
  name: '11',
  component: () => import('.../realTimeMonitoring.vue'),
  meta: {
    title: '实时监控',    // 页面标题
    icon: 'View'          // 菜单图标
  }
}
```

---

## 5. 首页配置

### 5.1 当前配置

**文件**: `src/router/index.ts` 第 148 行

```typescript
{
  path: '/',
  name: 'Layout',
  component: Layout,
  redirect: '/visual',  // ← 默认首页
  children: []
}
```

### 5.2 可选首页路径

| 路径 | 页面 | 说明 |
|-----|------|------|
| `/visual` | 可视中心 | 当前默认首页 |
| `/visualCenter` | 可视中心 | 同上（别名） |
| `/algorithmInference` | 算法推理平台 | AI 算法展示页 |
| `/monitoring/realtime` | 实时监控 | 监控预警主页 |

### 5.3 修改首页

修改 `redirect` 属性即可更改默认首页：

```typescript
// 修改为算法推理平台
redirect: '/algorithmInference'

// 修改为实时监控
redirect: '/monitoring/realtime'
```

---

## 6. 路由重置

### 6.1 resetAsyncRoutes 函数

**文件**: `src/router/index.ts`

```typescript
/**
 * 重置动态路由（用于登出时清除动态路由）
 */
export function resetAsyncRoutes(): void {
  asyncRoutesAdded = false
}
```

### 6.2 使用场景

**登出时清除动态路由**：

```typescript
async function logout() {
  // 1. 清除所有 Store 数据
  tokenStore.clearToken()
  userInfoStore.clearUserInfo()
  permissionsStore.clearPermissions()
  menusStore.clearMenuTree()

  // 2. 重置动态路由标记
  resetAsyncRoutes()

  // 3. 跳转到登录页
  router.push('/login')
}
```

**注意**: Vue Router 4 不支持 `removeRoute()` 批量删除，所以使用标记方式重新生成。

---

## 7. 路由命名规范

### 7.1 命名约定

| 规范 | 说明 | 示例 |
|-----|------|------|
| **路径** | 小写字母 + 连字符 | `/monitoring/realtime` |
| **路由名称** | 菜单 ID 的字符串形式 | `'11'`, `'12'` |
| **组件文件** | PascalCase 或 camelCase | `realTimeMonitoring.vue` |

### 7.2 路径兼容性

系统支持多路径映射到同一组件：

```typescript
// 后端可能返回不同路径，都映射到同一组件
'/visualCenter': () => import('.../visualCenter.vue'),
'/visual': () => import('.../visualCenter.vue'),

'/monitoring/realtime': () => import('.../realTimeMonitoring.vue'),
'/monitor/realtime': () => import('.../realTimeMonitoring.vue'),
```

---

## 8. 常见问题

### 8.1 路径没有对应组件

**警告信息**:
```
⚠️ 路径 "/unknown/path" (未知页面) 没有对应的组件，跳过
```

**解决方法**:
1. 在 `componentMap` 中添加映射
2. 或确保后端菜单 `path` 字段正确

### 8.2 路由不生效

**可能原因**:
1. `menu_type` 不是 `'menu'` 或 `1`
2. `path` 字段为空
3. `componentMap` 中没有对应组件
4. `setupAsyncRoutes` 未被调用

### 8.3 刷新后 404

**原因**: 动态路由未在刷新时重新添加

**解决**: 确保在 `main.ts` 中调用 `setupAsyncRoutes`

```typescript
// main.ts
import { useMenusStore } from '@/stores'
import { setupAsyncRoutes } from '@/router'

const menusStore = useMenusStore()

// 从 localStorage 恢复菜单树
if (menusStore.menuTree.length > 0) {
  setupAsyncRoutes(menusStore.menuTree)
}
```

---

**下一步**: 阅读 [路由守卫](./05-路由守卫.md) 了解路由访问控制机制
