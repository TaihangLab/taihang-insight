# 版本历史

> 太行视觉AI平台 - 路由与权限系统架构演进历史

---

## 目录

- [v1.0 - 单一 Store 架构](#v10---单一-store-架构)
- [v2.0 - 模块化 Store 架构](#v20---模块化-store-架构)
- [v2.1 - 组件库兼容性修复](#v21---组件库兼容性修复)
- [v2.2 - 日志清理与优化](#v22---日志清理与优化)

---

## v1.0 - 单一 Store 架构

**发布日期**: 2025-02-01

### 架构特点

```
单一 user Store
├── token: string
├── userInfo: UserInfo
├── permissions: string[]
└── menuTree: MenuItem[]
```

### 持久化配置

```typescript
export const useUserStore = defineStore('user', () => {
  // 所有数据在一个 Store 中
  const token = ref('')
  const userInfo = ref<UserInfo | null>(null)
  const permissions = ref<string[]>([])
  const menuTree = ref<MenuItem[]>([])

  return {
    token,
    userInfo,
    permissions,
    menuTree
  }
}, {
  persist: {
    key: 'taihang-user',  // 单一 localStorage 键
    storage: localStorage
  }
})
```

### 优缺点

| 优点 | 缺点 |
|-----|------|
| 简单直接 | 数据耦合 |
| 配置简单 | 持久化不灵活 |
| 易于理解 | 类型推导不精确 |

### 存在的问题

1. **数据耦合**: Token 和用户信息混在一起，登出时需要分别处理
2. **持久化粒度粗**: 所有数据存储在一个键下，无法单独控制
3. **类型安全弱**: Store 类型复杂，TypeScript 支持不佳

---

## v2.0 - 模块化 Store 架构

**发布日期**: 2025-02-23
**重要程度**: ⭐⭐⭐⭐⭐ 重大架构重构

### 架构变更

**从单一 Store 拆分为 4 个独立 Store**：

```
v1.0                          v2.0
┌──────────┐                 ┌──────────────┐
│  user    │                 │  Token       │
│  Store   │                 │  Store       │
├──────────┤                 ├──────────────┤
│ - token  │                 │  UserInfo    │
│ - user   │                 │  Store       │
│   Info   │                 ├──────────────┤
│ - perms  │                 │  Permissions │
│ - menus  │                 │  Store       │
└──────────┘                 ├──────────────┤
                              │  Menus       │
                              │  Store       │
                              └──────────────┘
```

### 新架构特点

#### 独立 Store 模块

| Store | 文件 | 状态 | localStorage Key |
|-------|------|------|------------------|
| Token | `token.ts` | `token: string` | `taihang-token` |
| UserInfo | `userInfo.ts` | `userInfo: UserInfo \| null` | `taihang-user-info` |
| Permissions | `permissions.ts` | `permissions: string[]` | `taihang-permissions` |
| Menus | `menus.ts` | `menuTree: MenuItem[]` | `taihang-menus` |

#### 独立持久化配置

```typescript
// token.ts
{
  persist: {
    key: 'taihang-token',
    storage: localStorage
  }
}

// userInfo.ts
{
  persist: {
    key: 'taihang-user-info',
    storage: localStorage
  }
}

// permissions.ts
{
  persist: {
    key: 'taihang-permissions',
    storage: localStorage
  }
}

// menus.ts
{
  persist: {
    key: 'taihang-menus',
    storage: localStorage
  }
}
```

### 主要改进

#### 1. 关注点分离

```typescript
// v1.0 - 混在一起
const userStore = useUserStore()
userStore.token           // Token
userStore.userInfo        // 用户信息
userStore.permissions    // 权限
userStore.menuTree       // 菜单

// v2.0 - 各司其职
const tokenStore = useTokenStore()
tokenStore.token          // 只有 Token

const userInfoStore = useUserInfoStore()
userInfoStore.userInfo    // 只有用户信息

const permissionsStore = usePermissionsStore()
permissionsStore.permissions  // 只有权限

const menusStore = useMenusStore()
menusStore.menuTree        // 只有菜单
```

#### 2. 独立持久化控制

```typescript
// 可以单独控制每个模块的持久化
tokenStore.clearToken()           // 只清除 Token
userInfoStore.clearUserInfo()     // 只清除用户信息
permissionsStore.clearPermissions() // 只清除权限
menusStore.clearMenuTree()         // 只清除菜单
```

#### 3. 更好的类型推导

```typescript
// v1.0 - 类型复杂
interface UserState {
  token: string
  userInfo: UserInfo | null
  permissions: string[]
  menuTree: MenuItem[]
}

// v2.0 - 类型精确
// token.ts - 只有 token 相关
interface TokenState {
  token: string
}

// userInfo.ts - 只有用户信息
interface UserInfoState {
  userInfo: UserInfo | null
}
```

#### 4. 动态路由系统

新增 `setupAsyncRoutes()` 函数，根据菜单树动态生成路由：

```typescript
export function setupAsyncRoutes(menuItems: any[]): void {
  const routes: RouteRecordRaw[] = []

  function processMenuItems(items: any[]) {
    for (const item of items) {
      const menuType = item.menu_type || item.permission_type || item.type
      const isMenu = menuType === 'menu' || menuType === 1

      if (isMenu && item.path) {
        const component = componentMap[item.path]
        if (component) {
          routes.push({
            path: item.path,
            name: String(item.id),
            component,
            meta: {
              title: item.menu_name,
              icon: item.icon
            }
          })
        }
      }

      if (item.children?.length) {
        processMenuItems(item.children)
      }
    }
  }

  processMenuItems(menuItems)

  routes.forEach(route => {
    router.addRoute('Layout', route)
  })
}
```

### 迁移影响

#### 登录流程变更

```typescript
// v1.0 - 单一 Store
const userStore = useUserStore()
userStore.setToken(token)
userStore.setUserInfo(userInfo)
userStore.setPermissions(perms)
userStore.setMenuTree(menu)

// v2.0 - 模块化 Store
const tokenStore = useTokenStore()
const userInfoStore = useUserInfoStore()
const permissionsStore = usePermissionsStore()
const menusStore = useMenusStore()

tokenStore.setToken(token)
userInfoStore.setUserInfo(userInfo)
permissionsStore.setPermissions(perms)
menusStore.setMenuTree(menu)
```

#### 路由守卫简化

```typescript
// v1.0 - 复杂的权限检查
router.beforeEach((to, from, next) => {
  // 检查 token
  // 检查路由权限
  // 检查菜单权限
  // ...
})

// v2.0 - 只检查认证
router.beforeEach((to, from, next) => {
  const token = getTokenFromStorage()
  if (!token) {
    next({ path: '/login' })
    return
  }
  next()
})
```

---

## v2.1 - 组件库兼容性修复

**发布日期**: 2025-02-23

### 问题背景

**现象**: 实时监控页面的树组件报错

```
TypeError: this.$on is not a function
```

**原因**: `vue-easy-tree` 是 Vue 2 组件，与 Vue 3 不兼容

### 解决方案

**替换为 Element Plus el-tree**：

#### RegionTree.vue

```vue
<!-- v2.0 - vue-easy-tree (Vue 2) -->
<vue-easy-tree
  ref="veTree"
  :data="treeData"
  :props="treeProps"
  @node-click="nodeClickHandler"
/>

<!-- v2.1 - el-tree (Vue 3) -->
<el-tree
  ref="treeRef"
  :data="treeData"
  :props="treeProps"
  :load="loadNode"
  lazy
  @node-click="nodeClickHandler"
/>
```

#### GroupTree.vue

```vue
<!-- v2.0 - vue-easy-tree -->
<vue-easy-tree
  ref="veTree"
  :data="treeData"
  :props="treeProps"
  @node-click="nodeClickHandler"
/>

<!-- v2.1 - el-tree -->
<el-tree
  ref="treeRef"
  :data="treeData"
  :props="treeProps"
  :load="loadNode"
  lazy
  @node-click="nodeClickHandler"
/>
```

### API 变更

| v2.0 (vue-easy-tree) | v2.1 (el-tree) |
|---------------------|----------------|
| `this.$refs.veTree.getNode()` | `this.$refs.treeRef.getNode()` |
| `this.$message.error()` | `ElMessage.error()` |
| `@node-click` | `@node-click` (相同) |

---

## v2.2 - 日志清理与优化

**发布日期**: 2025-02-23

### 优化内容

#### 1. 清理调试日志

**router/index.ts**:
```typescript
// v2.1 - 大量调试日志
console.log('生成动态路由:', route)
console.log('菜单树:', menuItems)

// v2.2 - 只保留关键警告
if (!component) {
  console.warn(`⚠️ 路径 "${path}" (${menuName}) 没有对应的组件，跳过`)
}
```

**SideMenu.vue**:
```typescript
// v2.1 - 详细日志
console.log('当前激活菜单:', activeMenu)
console.log('菜单树变化:', menuTree)

// v2.2 - 移除所有日志
watch(() => route.path, (newPath) => {
  activeMenu.value = newPath
  // 不再输出日志
})
```

#### 2. 路由守卫优化

```typescript
// v2.1 - 复杂逻辑
router.beforeEach((to, from, next) => {
  // 检查白名单
  // 检查 token
  // 检查路由权限
  // 检查菜单权限
  // ...
})

// v2.2 - 简化逻辑
router.beforeEach((to, from, next) => {
  // 只检查白名单和 token
  // 权限检查在组件内进行
})
```

---

## 版本对照表

| 版本 | 日期 | Store 架构 | 路由系统 | 主要变更 |
|-----|------|-----------|---------|---------|
| **v1.0** | 2025-02-01 | 单一 user Store | 静态路由 | 初始版本 |
| **v2.0** | 2025-02-23 | 模块化 Store (4个) | 动态路由 | 重大架构重构 |
| **v2.1** | 2025-02-23 | 同 v2.0 | 同 v2.0 | 组件库兼容性修复 |
| **v2.2** | 2025-02-23 | 同 v2.0 | 同 v2.0 | 日志清理与优化 |

---

## 迁移指南

### 从 v1.0 迁移到 v2.0

#### 1. 更新导入

```typescript
// v1.0
import { useUserStore } from '@/stores'
const userStore = useUserStore()

// v2.0
import { useTokenStore, useUserInfoStore, usePermissionsStore, useMenusStore } from '@/stores'
const tokenStore = useTokenStore()
const userInfoStore = useUserInfoStore()
const permissionsStore = usePermissionsStore()
const menusStore = useMenusStore()
```

#### 2. 更新登录流程

```typescript
// v1.0
userStore.setToken(token)
userStore.setUserInfo(userInfo)
userStore.setPermissions(perms)
userStore.setMenuTree(menu)

// v2.0
tokenStore.setToken(token)
userInfoStore.setUserInfo(userInfo)
permissionsStore.setPermissions(perms)
menusStore.setMenuTree(menu)
```

#### 3. 更新权限检查

```typescript
// v1.0
if (userStore.permissions.includes('system:user:add')) {
  // ...
}

// v2.0
if (permissionsStore.hasPermission('system:user:add')) {
  // ...
}
```

#### 4. 更新登出流程

```typescript
// v1.0
userStore.$reset()

// v2.0
tokenStore.clearToken()
userInfoStore.clearUserInfo()
permissionsStore.clearPermissions()
menusStore.clearMenuTree()
resetAsyncRoutes()
```

---

## 未来规划

### v3.0 - 计划中

**可能的新特性**：
- [ ] Vue 3.5+ 新特性支持
- [ ] TypeScript strict 模式
- [ ] 权限指令化（v-permission）
- [ ] 菜单虚拟滚动
- [ ] 路由级别的权限控制
- [ ] 细粒度的权限缓存策略

---

**文档完成**: 最后更新 2025-02-23
