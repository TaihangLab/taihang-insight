# 菜单渲染

> 太行视觉AI平台 - 侧边栏菜单组件与数据结构

---

## 目录

- [1. 菜单组件架构](#1-菜单组件架构)
- [2. 菜单数据结构](#2-菜单数据结构)
- [3. 菜单过滤逻辑](#3-菜单过滤逻辑)
- [4. 递归渲染](#4-递归渲染)

---

## 1. 菜单组件架构

### 1.1 组件层次结构

```
┌──────────────────────────────────────────────────────────┐
│  SideMenu.vue (侧边栏容器)                               │
│  ┌────────────────────────────────────────────────────────┐│
│  │  el-menu (Element Plus)                                ││
│  │  ├─ router: true (启用路由模式)                       ││
│  │  ├─ :default-active: activeMenu (当前激活菜单)         ││
│  │  └─ @select: 自动导航到对应路由                       ││
│  │                                                           ││
│  │  ┌────────────────────────────────────────────────────┐ ││
│  │  │  v-for 循环渲染 menuTree                          │ ││
│  │  │  ┌──────────────────────────────────────────────┐  ││
│  │  │  │  有 children?                                 │  ││
│  │  │  │    ├─ 是 → el-sub-menu (子菜单)              │  ││
│  │  │  │    └─ 否 → el-menu-item (菜单项)             │  ││
│  │  │  └──────────────────────────────────────────────┘  ││
│  │  └────────────────────────────────────────────────────┘ ││
│  └────────────────────────────────────────────────────────┘│
└──────────────────────────────────────────────────────────┘
```

### 1.2 SideMenu 组件

**文件**: `src/layout/SideMenu.vue`

```vue
<template>
  <div class="side-menu-container" :class="{ collapsed: isCollapsed }">
    <!-- Logo 区域 -->
    <div class="logo-section">
      <img src="@static/logo.png" alt="Logo" />
      <div class="logo-text-container" v-if="!isCollapsed">
        <div class="brand-row">
          <span class="brand-name-text">太行·慧眼</span>
        </div>
        <div class="system-title">太行视觉AI平台</div>
      </div>
    </div>

    <!-- 折叠按钮 -->
    <div class="collapse-trigger" @click="toggleCollapse">
      <el-icon v-if="isCollapsed"><Expand /></el-icon>
      <el-icon v-else><Fold /></el-icon>
    </div>

    <!-- 菜单区域 -->
    <el-scrollbar height="calc(100vh - 128px)">
      <el-menu
        :default-active="activeMenu"
        :collapse="isCollapsed"
        :collapse-transition="false"
        :unique-opened="true"
        router
      >
        <!-- 动态渲染菜单树 -->
        <template v-for="menuItem in menuTree" :key="menuItem.id">
          <!-- 有子菜单的情况 -->
          <el-sub-menu
            v-if="menuItem.children && menuItem.children.length > 0"
            :index="String(menuItem.path || menuItem.id)"
          >
            <template #title>
              <el-icon class="menu-icon">
                <component :is="getIconComponent(menuItem.icon)" />
              </el-icon>
              <span>{{ menuItem.menu_name }}</span>
            </template>

            <!-- 递归渲染子菜单 -->
            <template v-for="child in menuItem.children" :key="child.id">
              <el-menu-item
                v-if="child.menu_type !== 'button' && child.path"
                :index="String(child.path)"
              >
                <span>{{ child.menu_name }}</span>
              </el-menu-item>
            </template>
          </el-sub-menu>

          <!-- 没有子菜单的情况 -->
          <el-menu-item
            v-else-if="menuItem.menu_type !== 'button'"
            :index="String(menuItem.path || menuItem.id)"
          >
            <el-icon class="menu-icon">
              <component :is="getIconComponent(menuItem.icon)" />
            </el-icon>
            <span>{{ menuItem.menu_name }}</span>
          </el-menu-item>
        </template>
      </el-menu>
    </el-scrollbar>
  </div>
</template>

<script setup lang="ts">
import { ref, computed } from 'vue'
import { useRoute } from 'vue-router'
import { useMenusStore } from '@/stores'

const route = useRoute()
const menusStore = useMenusStore()

// 侧边栏折叠状态
const isCollapsed = ref(false)

// 当前激活的菜单
const activeMenu = ref(route.path)

// 从 Store 获取菜单树
const menuTree = computed(() => menusStore.menuTree || [])

// 监听路由变化
import { watch } from 'vue'
watch(
  () => route.path,
  (newPath) => {
    activeMenu.value = newPath
  }
)

// 图标映射
const iconMap: Record<string, any> = {
  'VideoCamera': VideoCamera,
  'Cpu': Cpu,
  'DataAnalysis': DataAnalysis,
  // ...
}

function getIconComponent(iconName?: string) {
  if (!iconName) return Setting
  return iconMap[iconName] || Setting
}

function toggleCollapse() {
  isCollapsed.value = !isCollapsed.value
}
</script>
```

---

## 2. 菜单数据结构

### 2.1 后端返回格式

```typescript
{
  "code": 200,
  "data": {
    "user_id": 1,
    "user_name": "admin",
    "menu_tree": [
      {
        "id": 1,
        "menu_name": "监控预警",
        "menu_type": "folder",     // folder=文件夹, menu=菜单, button=按钮
        "icon": "VideoCamera",
        "path": "/monitoring",
        "sort_order": 1,
        "status": 0,
        "children": [
          {
            "id": 11,
            "menu_name": "实时监控",
            "menu_type": "menu",
            "path": "/monitoring/realtime",
            "icon": "View"
          },
          {
            "id": 12,
            "menu_name": "统计分析",
            "menu_type": "menu",
            "path": "/monitoring/statistics",
            "icon": "Histogram"
          }
        ]
      }
    ]
  }
}
```

### 2.2 MenuItem 类型定义

```typescript
interface MenuItem {
  id: number
  menu_name?: string          // 菜单名称
  permission_name?: string    // 权限名称（兼容）
  name?: string               // 名称（兼容）
  menu_type?: string | number // 菜单类型: 'menu', 'folder', 'button' 或 1, 2, 3
  permission_type?: string | number // 权限类型（兼容）
  type?: string | number      // 类型（兼容）
  icon?: string               // 图标名称
  path?: string               // 路由路径
  sort_order?: number         // 排序
  status?: number             // 状态: 0=正常, 1=禁用
  visible?: boolean           // 是否可见
  children?: MenuItem[]       // 子菜单
}
```

### 2.3 菜单类型说明

| menu_type 值 | 类型 | 是否渲染 | 说明 |
|-------------|------|---------|------|
| `'folder'` 或 `2` | 文件夹 | ✅ | 有子菜单的容器 |
| `'menu'` 或 `1` | 菜单 | ✅ | 可点击的菜单项，有对应路由 |
| `'button'` 或 `3` | 按钮 | ❌ | 页面内按钮权限，不在菜单中显示 |

---

## 3. 菜单过滤逻辑

### 3.1 过滤规则

```typescript
function shouldRenderMenuItem(item: MenuItem): boolean {
  // 1. 只渲染启用状态的菜单
  if (item.status === 1) return false  // 1=禁用

  // 2. 过滤掉按钮类型
  const menuType = item.menu_type || item.permission_type || item.type
  if (menuType === 'button' || menuType === 3) return false

  // 3. 过滤掉设置为不可见的菜单
  if (item.visible === false) return false

  // 4. 必须有路径（menu 类型）
  if (menuType === 'menu' || menuType === 1) {
    if (!item.path) return false
  }

  return true
}
```

### 3.2 过滤流程

```
后端菜单树
    │
    ▼
┌─────────────────────────┐
│  遍历每个菜单项          │
└────────┬────────────────┘
         │
    ┌────┴────┐
    │         │
    ▼         ▼
检查 status  检查 menu_type
    │         │
    ▼         ▼
  status=0  menu_type!=button
    │         │
    └────┬────┘
         │
         ▼
    检查 visible
         │
         ▼
      visible!=false
         │
         ▼
    检查 path (menu 类型)
         │
         ▼
      有 path
         │
         ▼
    渲染菜单项
```

---

## 4. 递归渲染

### 4.1 渲染逻辑

```vue
<!-- 一级菜单 -->
<template v-for="menuItem in menuTree" :key="menuItem.id">
  <!-- 有子菜单：使用 el-sub-menu -->
  <el-sub-menu
    v-if="menuItem.children && menuItem.children.length > 0"
    :index="String(menuItem.path || menuItem.id)"
  >
    <template #title>
      <el-icon>
        <component :is="getIconComponent(menuItem.icon)" />
      </el-icon>
      <span>{{ menuItem.menu_name }}</span>
    </template>

    <!-- 二级菜单 -->
    <template v-for="child in menuItem.children" :key="child.id">
      <el-menu-item
        v-if="child.menu_type !== 'button' && child.path"
        :index="String(child.path)"
      >
        <span>{{ child.menu_name }}</span>
      </el-menu-item>
    </template>
  </el-sub-menu>

  <!-- 无子菜单：使用 el-menu-item -->
  <el-menu-item
    v-else-if="menuItem.menu_type !== 'button'"
    :index="String(menuItem.path || menuItem.id)"
  >
    <el-icon>
      <component :is="getIconComponent(menuItem.icon)" />
    </el-icon>
    <span>{{ menuItem.menu_name }}</span>
  </el-menu-item>
</template>
```

### 4.2 递归层次

```
menuTree (一级)
    │
    ├─→ 监控预警 (folder)
    │       │
    │       ├─→ 实时监控 (menu)
    │       ├─→ 统计分析 (menu)
    │       └─→ 预警档案 (menu)
    │
    ├─→ 设备配置 (folder)
    │       │
    │       ├─→ 摄像头 (menu)
    │       └─→ 本地视频 (menu)
    │
    └─→ 系统管理 (folder)
            │
            ├─→ 用户管理 (menu)
            ├─→ 角色管理 (menu)
            └─→ 权限管理 (menu)
```

### 4.3 当前激活菜单

```typescript
// 监听路由变化，更新当前激活菜单
watch(
  () => route.path,
  (newPath) => {
    activeMenu.value = newPath
  }
)
```

**el-menu 配置**：
```vue
<el-menu
  :default-active="activeMenu"  ← 当前激活菜单
  router                         ← 启用路由模式
>
```

---

## 5. 图标系统

### 5.1 图标映射

```typescript
const iconMap: Record<string, any> = {
  'VideoCamera': VideoCamera,
  'Cpu': Cpu,
  'DataAnalysis': DataAnalysis,
  'MagicStick': MagicStick,
  'Setting': Setting,
  'OfficeBuilding': OfficeBuilding,
  'User': User,
  'UserFilled': UserFilled,
  'Lock': Lock,
  'School': School,
  'Notebook': Notebook,
  'View': View,
  'Document': Document,
  'Tools': Tools,
  'Monitor': Monitor,
  'Platform': Platform,
  'Histogram': Histogram,
  'Warning': Warning,
  'DataLine': DataLine
}

function getIconComponent(iconName?: string) {
  if (!iconName) return Setting  // 默认图标
  return iconMap[iconName] || Setting
}
```

### 5.2 Element Plus 图标导入

```typescript
import {
  VideoCamera,
  Cpu,
  DataAnalysis,
  MagicStick,
  Setting,
  // ...
} from '@element-plus/icons-vue'
```

---

## 6. 菜单交互

### 6.1 点击事件

```vue
<el-menu router>
  <!-- router 模式启用后，点击自动跳转 -->
</el-menu>
```

**工作原理**：
1. 用户点击菜单项
2. Element Plus 触发 `@select` 事件
3. 由于 `router` 属性存在，自动调用 `router.push(path)`
4. 路由变化触发组件更新

### 6.2 折叠状态

```typescript
const isCollapsed = ref(false)

function toggleCollapse() {
  isCollapsed.value = !isCollapsed.value
}
```

**样式变化**：
```vue
<div class="side-menu-container" :class="{ collapsed: isCollapsed }">
```

```css
.side-menu-container {
  width: 224px;  /* 展开宽度 */
}

.side-menu-container.collapsed {
  width: 64px;   /* 折叠宽度 */
}
```

---

## 7. 菜单状态同步

### 7.1 与路由同步

```typescript
// 当前激活菜单
const activeMenu = ref(route.path)

// 监听路由变化
watch(
  () => route.path,
  (newPath) => {
    activeMenu.value = newPath
  }
)
```

### 7.2 与 Store 同步

```typescript
import { useMenusStore } from '@/stores'

const menusStore = useMenusStore()

// 从 Store 获取菜单树
const menuTree = computed(() => menusStore.menuTree || [])

// Store 中的数据变化会自动反映到菜单
```

---

## 8. 降级方案

**当 menuTree 为空时显示默认菜单**：

```vue
<!-- 降级方案：如果 menuTree 为空，显示默认菜单 -->
<template v-if="menuTree.length === 0">
  <!-- 监控预警 -->
  <el-sub-menu index="/monitoring">
    <template #title>
      <el-icon class="menu-icon"><VideoCamera /></el-icon>
      <span>监控预警</span>
    </template>
    <el-menu-item index="/monitoring/realtime">
      <span>实时监控</span>
    </el-menu-item>
    <el-menu-item index="/monitoring/statistics">
      <span>统计分析</span>
    </el-menu-item>
  </el-sub-menu>

  <!-- 设备配置 -->
  <el-sub-menu index="/deviceManage">
    <template #title>
      <el-icon class="menu-icon"><Cpu /></el-icon>
      <span>设备配置</span>
    </template>
    <el-menu-item index="/deviceManage/camera">
      <span>摄像头</span>
    </el-menu-item>
  </el-sub-menu>
</template>
```

**注意**：降级方案仅用于开发调试，生产环境应依赖后端菜单。

---

## 9. 常见问题

### 9.1 菜单不显示

**可能原因**：
1. `menuTree` 为空
2. 所有菜单项被过滤掉（status=1 或 menu_type=button）
3. 菜单项没有 `path` 字段

**排查方法**：
```typescript
console.log('菜单树:', menusStore.menuTree)
console.log('过滤后:', menuTree.value)
```

### 9.2 点击菜单无反应

**可能原因**：
1. el-menu 未设置 `router` 属性
2. 菜单项的 `:index` 与路由路径不匹配
3. 路由未正确注册

**解决**：
```vue
<el-menu router>  <!-- 确保有 router 属性 -->
  <el-menu-item :index="String(item.path)">  <!-- index 必须是字符串 -->
    {{ item.menu_name }}
  </el-menu-item>
</el-menu>
```

### 9.3 菜单图标不显示

**可能原因**：
1. 图标名称不在 `iconMap` 中
2. Element Plus 图标未正确导入

**解决**：
```typescript
// 确保图标已导入
import { VideoCamera, Cpu } from '@element-plus/icons-vue'

// 确保图标已映射
const iconMap: Record<string, any> = {
  'VideoCamera': VideoCamera,
  'Cpu': Cpu
}
```

---

**下一步**: 阅读 [权限控制](./07-权限控制.md) 了解权限检查机制
