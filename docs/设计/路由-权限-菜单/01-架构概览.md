# 架构概览

> 太行视觉AI平台 - 路由与权限系统整体架构设计

---

## 目录

- [1. 核心技术栈](#1-核心技术栈)
- [2. 架构设计原则](#2-架构设计原则)
- [3. 系统流程图](#3-系统流程图)
- [4. 数据流向](#4-数据流向)
- [5. 模块职责](#5-模块职责)

---

## 1. 核心技术栈

| 技术 | 版本 | 用途 |
|-----|------|------|
| **Vue** | 3.5.13 | 前端框架 |
| **Pinia** | 2.3.0 | 状态管理（Composition API） |
| **pinia-plugin-persistedstate** | - | Pinia 持久化插件，自动同步到 localStorage |
| **Vue Router** | 4.5.0 | 路由管理和动态路由 |
| **Axios** | 1.7.9 | HTTP 请求和拦截器 |
| **Element Plus** | 2.9.2 | UI 组件库（含 el-tree） |
| **TypeScript** | 5.6.3 | 类型系统 |

---

## 2. 架构设计原则

### 2.1 模块化原则

系统采用**模块化 Store 架构**，将不同职责的数据拆分为独立的 Store 模块：

```
单一 Store (旧架构)
        ↓
   拆分为 4 个独立 Store (新架构)
        ├── token.ts         - 认证令牌
        ├── userInfo.ts      - 用户信息
        ├── permissions.ts   - 权限列表
        └── menus.ts         - 菜单树
```

**优势**：
- 关注点分离
- 独立持久化控制
- 更好的类型推导
- 易于测试和维护

### 2.2 单向数据流

```
用户操作 → API 请求 → Store 更新 → localStorage 持久化 → UI 更新
```

### 2.3 懒加载策略

- 所有路由组件采用懒加载
- Store 数据按需加载
- 权限数据缓存复用

---

## 3. 系统流程图

### 3.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        前端应用 (Vue 3)                          │
│                                                                   │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    Pinia Stores (模块化)                      │ │
│  │  ┌───────────┐  ┌─────────────┐  ┌───────────┐  ┌─────────┐ │ │
│  │  │  Token   │  │  UserInfo   │  │Permission│  │  Menus   │ │ │
│  │  │  Store   │  │   Store     │  │  Store   │  │ Store   │ │ │
│  │  └───────────┘  └─────────────┘  └───────────┘  └─────────┘ │ │
│  │       │              │              │            │        │ │
│  │       ▼              ▼              ▼            ▼        │ │
│  │  ┌─────────┐    ┌──────────┐    ┌─────────┐  ┌────────┐ │ │
│  │  │token    │    │userInfo │    │permissions│ │menuTree│ │ │
│  │  └─────────┘    └──────────┘    └─────────┘  └────────┘ │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                              │                                    │
│  ┌───────────────────────────────┴────────────────────────────┐ │
│  │         pinia-plugin-persistedstate                         │ │
│  │         自动同步每个 Store 到 localStorage                 │ │
│  └────────────────────────────────────────────────────────────┘
│                              │
│                              ▼
│  ┌───────────────────────────────────────────────────────────────┐
│  │                    localStorage                                │
│  │  ┌────────────────┬────────────────┬────────────────┬───────┐│
│  │  │taihang-token   │taihang-user-  │taihang-perms │taihang- ││
│  │  │                │info           │              │menus    ││
│  │  │{token}         │{userInfo}     │{permissions} │{menuTree}││
│  │  └────────────────┴────────────────┴────────────────┴───────┘│
│  └───────────────────────────────────────────────────────────────┘
│                              │
│                              ▼
│  ┌───────────────────────────────────────────────────────────────┐
│  │                    Vue Router                               │
│  │  ┌────────────────┬────────────────┬────────────────┐       │
│  │  │  静态路由       │   动态路由     │  白名单路由    │       │
│  │  │  (定义文件)     │  (菜单生成)    │  /login等      │       │
│  │  └────────────────┴────────────────┴────────────────┘       │
│  └───────────────────────────────────────────────────────────────┘
│                                                                   │
└───────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌───────────────────────────────────────────────────────────────────┐
│                        后端 API                                    │
│  ┌──────────────┬──────────────┬──────────────┬──────────────┐│
│  │ POST /login  │ GET /info    │/permissions │  /menu       ││
│  └──────────────┴──────────────┴──────────────┴──────────────┘│
└───────────────────────────────────────────────────────────────────┘
```

### 3.2 用户访问流程图

```
┌─────────────────────────────────────────────────────────────────┐
│                      用户访问应用                                  │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
                   ┌────────────────────┐
                   │  应用启动 main.ts   │
                   └────────────────────┘
                             │
            ┌────────────────┴────────────────┐
            │                                 │
            ▼                                 ▼
    ┌───────────────┐               ┌───────────────┐
    │ 从 localStorage│               │ 后端 API 请求  │
    │ 读取已存数据   │               │ (如果无缓存)   │
    └───────────────┘               └───────────────┘
            │                                 │
            └────────────────┬────────────────┘
                             │
                             ▼
                   ┌────────────────────┐
                   │  setupAsyncRoutes  │
                   │  动态生成路由       │
                   └────────────────────┘
                             │
                             ▼
                   ┌────────────────────┐
                   │   路由守卫检查      │
                   │   beforeEach       │
                   └────────────────────┘
                      │              │
              未登录 │              │ 已登录
                      ▼              ▼
              ┌──────────┐    ┌──────────┐
              │ /login   │    │ 目标页面  │
              └──────────┘    └──────────┘
```

### 3.3 登录流程图

```
┌─────────────────────────────────────────────────────────────────┐
│              用户输入用户名、密码、租户编码                          │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
                    ┌────────────────────────┐
                    │ POST /api/v1/login     │
                    └────────────────────────┘
                             │
                             ▼
                    ┌────────────────────────┐
                    │ 返回 token             │
                    └────────────────────────┘
                             │
        ┌────────────────────┴────────────────────────────────┐
        │                                                         │
        ▼                                                         ▼
┌───────────────┐         ┌──────────────────────────────────────┐
│设置 Token     │         │ 并行获取用户数据                        │
│tokenStore.   │         │ Promise.all([getUserInfo,              │
│setToken()    │         │              getPermissions,            │
└───────────────┘         │              getMenuTree])            │
        │                 └──────────────────────────────────────┘
        │                            │
        │                ┌───────────┴──────────┐
        │                │                      │
        │                ▼                      ▼
        │       ┌─────────────┐      ┌──────────────┐
        │       │用户信息      │      │权限列表      │
        │       │userInfoStore│      │permissionsStore│
        │       └─────────────┘      └──────────────┘
        │                │                      │
        │                ▼                      ▼
        │       ┌──────────────────────────────────┐
        │       │           菜单树                    │
        │       │          menusStore.setMenuTree() │
        │       └──────────────────────────────────┘
        │
        ▼
┌────────────────────┐
│  持久化到 localStorage │
│  (自动同步)          │
└────────────────────┘
        │
        ▼
┌────────────────────┐
│  跳转到目标页面     │
│  router.push()      │
└────────────────────┘
```

---

## 4. 数据流向

### 4.1 认证数据流

```
登录请求
    │
    ├─→ Token Store → localStorage → 请求拦截器携带
    │
    ├─→ UserInfo Store → localStorage → 用户信息显示
    │
    ├─→ Permissions Store → localStorage → 权限检查
    │
    └─→ Menus Store → localStorage → 动态路由 + 菜单渲染
```

### 4.2 路由数据流

```
菜单树 (后端返回)
    │
    ├─→ setupAsyncRoutes()
    │       │
    │       ├─→ componentMap 查找
    │       │
    │       └─→ router.addRoute('Layout', route)
    │
    └─→ 菜单组件渲染
            │
            ├─→ 过滤 button 类型
            │
            ├─→ 标准化字段
            │
            └─→ 递归渲染 el-menu
```

---

## 5. 模块职责

### 5.1 Store 模块

| 模块 | 职责 | 状态 |
|-----|------|-----|
| **Token** | 管理 JWT Token，提供认证状态检查 | `token: string` |
| **UserInfo** | 管理用户基本信息，提供用户属性访问 | `userInfo: UserInfo` |
| **Permissions** | 管理权限码列表，提供权限检查方法 | `permissions: string[]` |
| **Menus** | 管理菜单树，提供菜单查询和路由提取 | `menuTree: MenuItem[]` |

### 5.2 路由模块

| 模块 | 职责 |
|-----|------|
| **路由配置** | 定义静态路由和组件映射 |
| **动态路由生成** | 根据菜单树动态添加路由 |
| **路由守卫** | 执行认证检查和导航控制 |

### 5.3 菜单模块

| 模块 | 职责 |
|-----|------|
| **菜单数据** | 管理和过滤菜单项 |
| **菜单渲染** | 递归渲染菜单结构 |
| **菜单交互** | 处理菜单点击和导航 |

---

## 6. 关键设计决策

### 6.1 为什么使用独立 Store？

**问题**: 单一 user store 导致数据耦合，持久化策略不灵活

**解决**: 拆分为 4 个独立 store
- 每个模块独立持久化
- 按需加载和清除
- 更好的类型安全

### 6.2 为什么使用动态路由？

**问题**: 硬编码路由无法适应不同用户的权限

**解决**: 根据后端菜单树动态生成路由
- 路由与权限完全解耦
- 无权限页面自动不可访问
- 菜单与路由自动同步

### 6.3 为什么路由守卫只检查 token？

**问题**: 复杂的权限检查影响性能

**解决**: 守卫只验证认证状态，细粒度权限在组件内检查
- 守卫逻辑简单高效
- 组件级别灵活控制
- 错误路由自然返回 404

---

**下一步**: 阅读 [数据存储策略](./02-数据存储策略.md) 了解 Store 模块的详细实现
