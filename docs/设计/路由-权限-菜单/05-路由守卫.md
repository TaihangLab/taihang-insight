# 路由守卫

> 太行视觉AI平台 - 路由访问控制与认证检查

---

## 目录

- [1. 守卫配置](#1-守卫配置)
- [2. 白名单机制](#2-白名单机制)
- [3. 认证检查](#3-认证检查)
- [4. 流程图](#4-流程图)

---

## 1. 守卫配置

### 1.1 全局前置守卫

**文件**: `src/router/index.ts`

```typescript
/**
 * 全局前置守卫 - 认证检查
 * 动态路由已在 main.ts 中根据菜单创建，无需重复校验
 */
router.beforeEach((to, _from, next) => {
  // ========== 白名单 ==========
  const whiteList = ['/login', '/test', '/play/wasm', '/play/rtc',
                   '/gbRecordDetail', '/cloudRecordDetail']

  const isWhitelisted = whiteList.some(path => to.path.startsWith(path))

  if (isWhitelisted) {
    next()
    return
  }

  // ========== 认证检查 ==========
  const token = getTokenFromStorage()

  // 未登录，重定向到登录页
  if (!token) {
    console.warn('⚠️ 未登录，重定向到登录页')
    next({
      path: '/login',
      query: { redirect: to.fullPath }
    })
    return
  }

  // 已登录，直接放行
  // 动态路由已在 main.ts 中根据菜单创建完成
  // Vue Router 会自动处理路由匹配，不存在路由会返回 404
  next()
})
```

### 1.2 Token 读取函数

```typescript
/**
 * 从 localStorage 获取 token
 *
 * ⚠️ 注意：这是路由守卫专用的特殊处理
 * 其他地方应始终使用 tokenStore.token
 */
function getTokenFromStorage(): string | null {
  try {
    const token = localStorage.getItem(StorageKey.ADMIN_TOKEN)
    return token || null
  } catch {
    return null
  }
}
```

**为什么路由守卫直接读取 localStorage？**

| 原因 | 说明 |
|-----|------|
| **同步执行** | 路由守卫需要同步返回，不能等待异步初始化 |
| **初始化时机** | 守卫在 Pinia 持久化插件完成前可能已执行 |
| **可靠性** | 避免异步初始化导致的认证判断错误 |

---

## 2. 白名单机制

### 2.1 白名单路由

| 路由模式 | 说明 | 示例 |
|---------|------|------|
| `/login` | 登录页面 | `/login` |
| `/test` | 测试页面 | `/test` |
| `/play/wasm` | Wasm 播放器 | `/play/wasm/xxx` |
| `/play/rtc` | RTC 播放器 | `/play/rtc/xxx` |
| `/gbRecordDetail` | 国标录像详情 | `/gbRecordDetail/1/2/` |
| `/cloudRecordDetail` | 云录像详情 | `/cloudRecordDetail/app/stream` |

### 2.2 白名单判断逻辑

```typescript
const whiteList = ['/login', '/test', '/play/wasm', '/play/rtc',
                   '/gbRecordDetail', '/cloudRecordDetail']

// 使用 startsWith 判断，支持子路径
const isWhitelisted = whiteList.some(path => to.path.startsWith(path))

if (isWhitelisted) {
  next()  // 直接放行，不需要认证
  return
}
```

### 2.3 添加白名单路由

如果需要添加新的白名单路由：

```typescript
const whiteList = [
  '/login',
  '/test',
  '/play/wasm',
  '/play/rtc',
  '/gbRecordDetail',
  '/cloudRecordDetail',
  '/your-new-route'  // ← 添加新路由
]
```

---

## 3. 认证检查

### 3.1 检查逻辑

```typescript
const token = getTokenFromStorage()

if (!token) {
  // 未登录，重定向到登录页
  next({
    path: '/login',
    query: { redirect: to.fullPath }  // 保存原始目标路径
  })
  return
}

// 已登录，直接放行
next()
```

### 3.2 重定向参数

```typescript
// 登录成功后跳转到原始目标页面
const redirect = route.query.redirect as string || '/'
router.push(redirect)
```

**示例**：
- 用户访问 `/monitoring/realtime` 但未登录
- 重定向到 `/login?redirect=/monitoring/realtime`
- 登录成功后跳转回 `/monitoring/realtime`

### 3.3 Token 过期处理

**响应拦截器** (axios)：

```typescript
// src/api/auth/instance.ts
authAxios.interceptors.response.use(
  (response) => response,
  (error) => {
    if (error.response?.status === 401) {
      // Token 过期或无效
      ElMessage.error('登录已过期，请重新登录')

      // 清除 Token
      const tokenStore = useTokenStore()
      tokenStore.clearToken()

      // 跳转到登录页
      window.location.href = '/login'
    }
    return Promise.reject(error)
  }
)
```

---

## 4. 流程图

### 4.1 路由守卫决策流程

```
┌─────────────────────────────────────────────────────────────┐
│                     用户导航请求                               │
│                  router.push('/some/path')                   │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
                   ┌────────────────┐
                   │  是否在白名单？  │
                   └────────────────┘
                      │         │
                    是│         │否
                      ▼         ▼
              ┌──────────┐  ┌────────────────┐
              │   放行    │  │ 读取 localStorage│
              │  next()  │  │ (StorageKey.     │
              └──────────┘  │  ADMIN_TOKEN)    │
                             └────────────────┘
                                      │
                                      ▼
                            ┌────────────────┐
                            │  是否有 token？ │
                            └────────────────┘
                               │         │
                              否│         │是
                               ▼         ▼
                       ┌──────────┐  ┌──────────┐
                       │ 跳转登录  │  │   放行   │
                       │ /login?  │  │  next()  │
                       │ redirect=│  └──────────┘
                       │ xxx      │       │
                       └──────────┘       ▼
                                ┌────────────────────┐
                                │  路由匹配           │
                                │  ├─ 存在 → 渲染组件  │
                                │  └─ 不存在 → 404    │
                                └────────────────────┘
```

### 4.2 完整导航流程

```
┌─────────────────────────────────────────────────────────────┐
│                   用户点击链接或输入 URL                       │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────┐
│                  URL 变化触发路由导航                           │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────┐
│                  router.beforeEach 守卫                       │
└────────────────────────────┬────────────────────────────────────┘
                             │
                    ┌────────┴────────┐
                    │                 │
                白名单              非白名单
                    │                 │
                    ▼                 ▼
            ┌───────────┐   ┌─────────────────┐
            │  next()   │   │ 检查 token       │
            │  直接放行  │   └────────┬────────┘
            └───────────│            │
                         │    ┌───────┴───────┐
                         │    │               │
                         │  有 token      无 token
                         │    │               │
                         │    ▼               ▼
                         │ ┌─────────┐  ┌──────────┐
                         │ │ next()  │  │ 重定向    │
                         │ │ 放行    │  │ /login   │
                         │ └─────────┘  └──────────┘
                         │
                         ▼
              ┌─────────────────────────────┐
              │      路由匹配                 │
              │      router.resolve()        │
              └────────────┬────────────────┘
                           │
              ┌────────────┴────────────┐
              │                         │
         匹配成功                   匹配失败
              │                         │
              ▼                         ▼
    ┌───────────────────┐     ┌──────────────────┐
    │   加载路由组件     │     │    返回 404       │
    │   (懒加载)        │     │    (可选处理)     │
    └─────────┬─────────┘     └──────────────────┘
              │
              ▼
    ┌───────────────────┐
    │   组件渲染         │
    └───────────────────┘
```

### 4.3 登录后跳转流程

```
┌─────────────────────────────────────────────────────────────┐
│           用户访问 /monitoring/realtime                     │
│                    (未登录)                                 │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────┐
│              路由守卫检测到无 token                           │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────┐
│          重定向到 /login?redirect=/monitoring/realtime       │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────┐
│              用户输入用户名密码登录                            │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────┐
│              登录成功，设置 token 等数据                        │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────┐
│          读取 redirect 参数，跳转到原始目标                    │
│          router.push('/monitoring/realtime')                  │
└─────────────────────────────────────────────────────────────┘
```

---

## 5. 后置钩子

### 5.1 页面标题设置

**文件**: `src/router/index.ts`

```typescript
/**
 * 全局后置钩子 - 设置页面标题
 */
router.afterEach((to) => {
  const title = to.meta?.title as string | undefined
  if (title) {
    document.title = `${title} - 太行视觉AI平台`
  } else {
    document.title = '太行视觉AI平台'
  }
})
```

### 5.2 标题设置逻辑

```
afterEach 钩子
    │
    ├─→ 获取 to.meta.title
    │
    ├─→ 如果有 title → "页面标题 - 太行视觉AI平台"
    │
    └─→ 如果无 title → "太行视觉AI平台"
```

---

## 6. 路由元信息

### 6.1 meta 字段定义

```typescript
{
  path: '/monitoring/realtime',
  name: '11',
  component: () => import('...'),
  meta: {
    title: '实时监控',   // 页面标题
    icon: 'View'         // 菜单图标
  }
}
```

### 6.2 可用的 meta 字段

| 字段 | 类型 | 说明 |
|-----|------|------|
| `title` | `string` | 页面标题，显示在浏览器标签和页面头部 |
| `icon` | `string` | 菜单图标名称，对应 Element Plus 图标 |
| `hidden` | `boolean` | 是否隐藏该路由（不在菜单中显示） |

---

## 7. 常见问题

### 7.1 登录后跳转到首页而非原页面

**原因**: redirect 参数丢失

**解决**: 确保登录成功后正确读取 redirect 参数

```typescript
// Login.vue
const redirect = (route.query.redirect as string) || '/'
router.push(redirect)
```

### 7.2 刷新页面后跳转到登录页

**原因**: Token 未持久化或已过期

**检查**:
1. Token Store 是否正确配置持久化
2. localStorage 中是否有 `taihang-token`
3. Token 是否已过期（检查后端配置）

### 7.3 白名单路由仍然需要登录

**原因**: 白名单配置不正确

**解决**: 确保路由路径正确匹配

```typescript
// ❌ 错误：完整路径匹配
const whiteList = ['/play/wasm/xxx']  // 只匹配这个特定路径

// ✅ 正确：使用 startsWith 匹配
const whiteList = ['/play/wasm']  // 匹配 /play/wasm 开头的所有路径
```

### 7.4 404 页面处理

**当前行为**: 不存在的路由自动返回 404（Vue Router 默认行为）

**可选**: 添加自定义 404 页面

```typescript
// 在 constantRoutes 中添加
{
  path: '/:pathMatch(.*)*',
  name: 'NotFound',
  component: () => import('../pages/commons/NotFound.vue'),
  meta: { title: '页面不存在' }
}
```

---

## 8. 守卫最佳实践

| 实践 | 说明 |
|-----|------|
| ✅ 守卫逻辑简洁 | 只做认证检查，不做复杂权限判断 |
| ✅ 使用白名单 | 公开路由添加到白名单，而非在守卫中判断 |
| ✅ 保存重定向参数 | 登录后跳转到原始目标页面 |
| ✅ 同步执行 | 守卫中避免异步操作，保证快速响应 |
| ❌ 避免复杂逻辑 | 细粒度权限控制在组件内处理 |
| ❌ 避免循环跳转 | 确保重定向逻辑正确，避免无限循环 |

---

**下一步**: 阅读 [菜单渲染](./06-菜单渲染.md) 了解菜单组件如何动态渲染
