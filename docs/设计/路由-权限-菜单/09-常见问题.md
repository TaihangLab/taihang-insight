# 常见问题

> 太行视觉AI平台 - 路由与权限系统常见问题与解决方案

---

## 目录

- [1. 登录相关](#1-登录相关)
- [2. 路由相关](#2-路由相关)
- [3. 菜单相关](#3-菜单相关)
- [4. 权限相关](#4-权限相关)
- [5. 存储相关](#5-存储相关)

---

## 1. 登录相关

### 1.1 登录后跳转到首页而非原页面

**现象**: 用户访问 `/monitoring/realtime`，未登录跳转到登录页，登录后跳转到首页而非 `/monitoring/realtime`

**原因**: redirect 参数未正确读取

**解决**: 检查登录成功后的跳转逻辑

```typescript
// Login.vue
const redirect = (route.query.redirect as string) || '/'
router.push(redirect)
```

### 1.2 Token 过期未自动跳转登录页

**现象**: API 返回 401，但页面没有跳转

**原因**: 响应拦截器未正确处理 401

**解决**: 检查 axios 响应拦截器

```typescript
// src/api/auth/instance.ts
authAxios.interceptors.response.use(
  (response) => response,
  (error) => {
    if (error.response?.status === 401) {
      const tokenStore = useTokenStore()
      tokenStore.clearToken()
      window.location.href = '/login'  // ← 使用 location.href 强制跳转
    }
    return Promise.reject(error)
  }
)
```

### 1.3 登录成功但数据未设置

**现象**: 登录成功但刷新后又回到登录页

**原因**: 持久化未生效或数据未正确设置

**排查**:
```typescript
// 检查 Store 是否正确设置
console.log('Token:', tokenStore.token)
console.log('UserInfo:', userInfoStore.userInfo)
console.log('Menus:', menusStore.menuTree)

// 检查 localStorage
console.log('localStorage:', localStorage.getItem('taihang-token'))
```

**解决**: 确保使用 `setToken()` 等方法而非直接赋值

```typescript
// ✅ 正确
tokenStore.setToken(token)

// ❌ 错误
tokenStore.token = token  // 可能不会触发持久化
```

---

## 2. 路由相关

### 2.1 刷新页面后 404

**现象**: 直接访问或刷新某个页面，显示 404

**原因**: 动态路由未在刷新时重新添加

**解决**: 确保在 `main.ts` 中调用 `setupAsyncRoutes`

```typescript
// main.ts
import { useMenusStore } from '@/stores'
import { setupAsyncRoutes } from '@/router'

const menusStore = useMenusStore()

// 从 localStorage 恢复的菜单树
// 持久化插件会自动恢复到 menusStore.menuTree
if (menusStore.menuTree.length > 0) {
  setupAsyncRoutes(menusStore.menuTree)
}
```

### 2.2 路径没有对应组件的警告

**现象**: 控制台显示 `⚠️ 路径 "/xxx" 没有对应的组件，跳过`

**原因**: 后端返回的路径在 `componentMap` 中没有对应映射

**解决**: 在 `componentMap` 中添加映射

```typescript
// src/router/index.ts
const componentMap: Record<string, () => Promise<any>> = {
  // 添加新的路径映射
  '/xxx': () => import('../pages/xxx.vue')
}
```

### 2.3 路由重复添加警告

**现象**: 控制台显示路由重复添加的警告

**原因**: `setupAsyncRoutes` 被多次调用

**解决**: 检查 `asyncRoutesAdded` 标记

```typescript
// 确保只调用一次
if (!asyncRoutesAdded) {
  setupAsyncRoutes(menuTree)
}
```

### 2.4 白名单路由仍需登录

**现象**: 访问白名单路由被重定向到登录页

**原因**: 白名单路径配置不正确

**解决**: 检查白名单配置

```typescript
// 确保路径正确
const whiteList = ['/login', '/test', '/play/wasm', '/play/rtc']

// 使用 startsWith 匹配子路径
const isWhitelisted = whiteList.some(path => to.path.startsWith(path))
```

---

## 3. 菜单相关

### 3.1 菜单不显示

**现象**: 侧边栏菜单为空

**原因**:
1. `menuTree` 为空
2. 所有菜单被过滤掉
3. API 返回失败

**排查**:
```typescript
// 检查菜单数据
console.log('Menu Tree:', menusStore.menuTree)

// 检查过滤后
console.log('Filtered:', menuTree.value)

// 检查 API 响应
const result = await authAPI.getMenuTree()
console.log('API Result:', result)
```

### 3.2 菜单图标不显示

**现象**: 菜单项旁边没有图标

**原因**:
1. 图标名称不在 `iconMap` 中
2. Element Plus 图标未导入

**解决**:
```typescript
// 确保图标已导入
import { VideoCamera, Cpu } from '@element-plus/icons-vue'

// 确保图标已映射
const iconMap: Record<string, any> = {
  'VideoCamera': VideoCamera,
  'Cpu': Cpu
}
```

### 3.3 点击菜单无反应

**现象**: 点击菜单项，页面没有跳转

**原因**:
1. el-menu 未设置 `router` 属性
2. `:index` 与路由路径不匹配
3. 路由未正确注册

**解决**:
```vue
<el-menu router>  <!-- 确保有 router 属性 -->
  <el-menu-item :index="String(item.path)">  <!-- index 必须是字符串 -->
    {{ item.menu_name }}
  </el-menu-item>
</el-menu>
```

### 3.4 菜单折叠后样式异常

**现象**: 折叠侧边栏后，菜单项显示不正常

**原因**: CSS 样式未正确处理折叠状态

**解决**: 检查折叠状态的样式

```css
.side-menu-container.collapsed .logo-text-container {
  display: none;
}

.side-menu-container.collapsed .el-menu {
  width: 64px;
}
```

---

## 4. 权限相关

### 4.1 权限检查不生效

**现象**: 有权限但按钮不显示，或无权限但按钮仍显示

**原因**:
1. `permissionsStore` 未正确初始化
2. 权限码名称不匹配
3. Store 中没有权限数据

**排查**:
```typescript
// 检查权限列表
console.log('All Permissions:', permissionsStore.getAllPermissions())

// 检查具体权限
console.log('Has Permission:', permissionsStore.hasPermission('system:user:add'))
```

### 4.2 权限未及时更新

**现象**: 角色变更后，权限没有更新

**原因**: 权限列表缓存到 localStorage，需要重新获取

**解决**: 角色变更后提示用户重新登录，或提供"刷新权限"功能

```typescript
async function refreshPermissions() {
  const result = await authAPI.getPermissions()
  if (result.code === 200) {
    permissionsStore.setPermissions(result.data.permission_codes)
    ElMessage.success('权限已更新')
  }
}
```

### 4.3 权限码命名不一致

**现象**: 前后端权限码不匹配

**原因**: 权限码命名规范不一致

**解决**: 统一使用 `模块:功能:操作` 格式

```typescript
// 推荐
'monitor:realtime:page'
'system:user:add'
'skill:device:edit'

// 避免
'realtime_page'
'user.add'
'device-edit'
```

---

## 5. 存储相关

### 5.1 数据未持久化

**现象**: 刷新页面后数据丢失

**原因**:
1. 持久化插件未正确配置
2. Store 的 persist 配置错误

**解决**: 检查持久化配置

```typescript
// src/stores/modules/token.ts
export const useTokenStore = defineStore('token', () => {
  // ...
}, {
  persist: {
    key: 'taihang-token',  // ← 确保有 key
    storage: localStorage   // ← 确保有 storage
  }
})
```

### 5.2 持久化数据读取延迟

**现象**: 应用启动时 Store 数据为空，稍后才出现

**原因**: pinia-plugin-persistedstate 异步恢复数据

**解决**: 路由守卫中直接读取 localStorage（见 `02-数据存储策略.md`）

### 5.3 localStorage 数据错误

**现象**: Store 数据与 localStorage 不一致

**原因**: 直接修改 localStorage 绕过了 Store

**解决**: 始终通过 Store 修改数据

```typescript
// ✅ 正确
tokenStore.setToken(newToken)

// ❌ 错误
localStorage.setItem('taihang-token', newToken)  // Store 不会感知到变化
```

### 5.4 清除数据不彻底

**现象**: 登出后仍有残留数据

**原因**: 只清除了部分 Store

**解决**: 登出时清除所有 Store

```typescript
async function logout() {
  tokenStore.clearToken()
  userInfoStore.clearUserInfo()
  permissionsStore.clearPermissions()
  menusStore.clearMenuTree()
  resetAsyncRoutes()
  router.push('/login')
}
```

---

## 6. 开发调试

### 6.1 查看当前 Store 状态

```typescript
// 在浏览器控制台执行
import { useTokenStore, useUserInfoStore, usePermissionsStore, useMenusStore } from '@/stores'

const tokenStore = useTokenStore()
const userInfoStore = useUserInfoStore()
const permissionsStore = usePermissionsStore()
const menusStore = useMenusStore()

console.log('Token:', tokenStore.token)
console.log('UserInfo:', userInfoStore.userInfo)
console.log('Permissions:', permissionsStore.permissions)
console.log('MenuTree:', menusStore.menuTree)
```

### 6.2 查看 localStorage 数据

```javascript
// 在浏览器控制台执行
console.log('Token:', localStorage.getItem('taihang-token'))
console.log('UserInfo:', localStorage.getItem('taihang-user-info'))
console.log('Permissions:', localStorage.getItem('taihang-permissions'))
console.log('Menus:', localStorage.getItem('taihang-menus'))
```

### 6.3 查看当前路由

```typescript
// 在浏览器控制台执行
import { useRoute } from 'vue-router'

const route = useRoute()
console.log('Current Route:', route.path)
console.log('Route Params:', route.params)
console.log('Route Query:', route.query)
```

### 6.4 查看已注册的路由

```typescript
// 在浏览器控制台执行
import router from '@/router'

console.log('All Routes:', router.getRoutes())
```

---

## 7. 性能问题

### 7.1 首屏加载慢

**原因**:
1. 组件未懒加载
2. 菜单树过大
3. API 请求串行

**优化**:
```typescript
// 1. 使用懒加载
const componentMap = {
  '/path': () => import('./pages/xxx.vue')  // ← 懒加载
}

// 2. 并行请求数据
const [userInfo, permissions, menus] = await Promise.all([
  authAPI.getUserInfo(),
  authAPI.getPermissions(),
  authAPI.getMenuTree()
])
```

### 7.2 菜单渲染卡顿

**原因**: 菜单树过大，递归渲染性能问题

**解决**: 考虑虚拟滚动或分页加载

```vue
<!-- 使用虚拟滚动 -->
<el-virtual-list
  :data="menuTree"
  :item-size="40"
>
  <template #default="{ item }">
    <menu-item :data="item" />
  </template>
</el-virtual-list>
```

---

## 8. 兼容性问题

### 8.1 Safari 存储问题

**现象**: Safari 隐私模式下 localStorage 不可用

**解决**: 添加 try-catch 处理

```typescript
function getTokenFromStorage(): string | null {
  try {
    return localStorage.getItem(StorageKey.ADMIN_TOKEN)
  } catch {
    // localStorage 不可用，返回 null
    return null
  }
}
```

### 8.2 低版本浏览器兼容

**问题**: ES6+ 语法不支持

**解决**: Vite 会自动转译，确保 `browserslist` 配置正确

```json
// package.json
{
  "browserslist": [
    "last 2 versions",
    "not dead",
    "not ie 11"
  ]
}
```

---

**下一步**: 阅读 [版本历史](./10-版本历史.md) 了解架构演进历史
