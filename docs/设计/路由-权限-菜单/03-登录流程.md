# 登录流程

> 太行视觉AI平台 - 用户认证与登录完整流程

---

## 目录

- [1. 登录页面](#1-登录页面)
- [2. 登录 API](#2-登录-api)
- [3. 登录代码实现](#3-登录代码实现)
- [4. 流程图](#4-流程图)
- [5. 登出流程](#5-登出流程)

---

## 1. 登录页面

### 1.1 页面位置

**文件**: `src/pages/commons/Login.vue`

### 1.2 页面结构

```vue
<template>
  <div class="login-container">
    <div class="login-form">
      <!-- Logo 和标题 -->
      <div class="login-header">
        <h1>太行视觉AI平台</h1>
      </div>

      <!-- 租户选择 -->
      <el-select v-model="selectedTenant" placeholder="选择租户">
        <el-option
          v-for="tenant in tenants"
          :key="tenant.code"
          :label="tenant.name"
          :value="tenant.code"
        />
      </el-select>

      <!-- 用户名输入 -->
      <el-input
        v-model="username"
        placeholder="请输入用户名"
        prefix-icon="User"
      />

      <!-- 密码输入 -->
      <el-input
        v-model="password"
        type="password"
        placeholder="请输入密码"
        prefix-icon="Lock"
        @keyup.enter="login"
      />

      <!-- 登录按钮 -->
      <el-button
        type="primary"
        :loading="isLoging"
        @click="login"
      >
        登录
      </el-button>
    </div>
  </div>
</template>
```

---

## 2. 登录 API

### 2.1 API 接口

**端点**: `POST /api/v1/login`

**请求参数**:
```typescript
{
  username: string      // 用户名
  password: string      // 密码
  tenant_code?: string  // 租户编码（可选）
}
```

**响应格式**:
```typescript
{
  code: 200,
  message: "成功",
  data: {
    token: string       // JWT Token
  }
}
```

### 2.2 相关 API

| API | 端点 | 说明 |
|-----|------|------|
| **登录** | `POST /api/v1/login` | 获取认证 Token |
| **用户信息** | `GET /api/v1/user/info` | 获取当前用户信息 |
| **权限列表** | `GET /api/v1/permissions` | 获取用户权限码 |
| **菜单树** | `GET /api/v1/menu/tree` | 获取用户菜单树 |

---

## 3. 登录代码实现

### 3.1 完整登录函数

**文件**: `src/pages/commons/Login.vue`

```typescript
import { ref } from 'vue'
import { useRouter, useRoute } from 'vue-router'
import { ElMessage } from 'element-plus'
import { authAPI } from '@/api/auth'
import { useTokenStore, useUserInfoStore, usePermissionsStore, useMenusStore } from '@/stores'

// ========== 状态 ==========
const username = ref('')
const password = ref('')
const selectedTenant = ref('')
const isLoging = ref(false)

const router = useRouter()
const route = useRoute()

const tokenStore = useTokenStore()
const userInfoStore = useUserInfoStore()
const permissionsStore = usePermissionsStore()
const menusStore = useMenusStore()

// ========== 登录函数 ==========
async function login(): Promise<void> {
  // 1. 表单验证
  if (!username.value || !password.value) {
    ElMessage.warning('请输入用户名和密码')
    return
  }

  isLoging.value = true

  try {
    // 2. 调用登录 API
    const result = await authAPI.login({
      username: username.value,
      password: password.value,
      tenant_code: selectedTenant.value
    })

    if (result.code === 200) {
      const { token } = result.data

      // 3. 设置 Token
      tokenStore.setToken(token)

      // 4. 并行获取完整用户数据
      const [userInfoResult, permissionsResult, menuTreeResult] = await Promise.all([
        authAPI.getUserInfo(),
        authAPI.getPermissions(),
        authAPI.getMenuTree()
      ])

      // 5. 设置用户信息
      if (userInfoResult.code === 200) {
        const userData = userInfoResult.data
        userInfoStore.setUserInfo({
          id: userData.user_id,
          username: userData.user_name,
          user_name: userData.user_name,
          nick_name: userData.nick_name,
          email: userData.email,
          phone: userData.phone,
          avatar: userData.avatar,
          tenantId: userData.tenant_id,
          tenant_id: userData.tenant_id,
          dept_id: userData.dept_id,
          position_id: userData.position_id,
          status: userData.status,
          gender: userData.gender
        })
      }

      // 6. 设置权限列表
      if (permissionsResult.code === 200) {
        const perms = permissionsResult.data.permission_codes || []
        permissionsStore.setPermissions(perms)
      }

      // 7. 设置菜单树
      if (menuTreeResult.code === 200) {
        const menu = menuTreeResult.data.menu_tree || []
        menusStore.setMenuTree(menu)
      }

      // 8. 等待持久化完成
      await new Promise(resolve => setTimeout(resolve, 100))

      // 9. 跳转到目标页面
      const redirect = (route.query.redirect as string) || '/'
      router.push(redirect)
    } else {
      ElMessage.error(result.message || '登录失败')
    }
  } catch (error) {
    console.error('登录请求失败:', error)
    ElMessage.error('网络错误，请稍后重试')
  } finally {
    isLoging.value = false
  }
}
```

### 3.2 关键步骤说明

#### 步骤 1: 表单验证
```typescript
if (!username.value || !password.value) {
  ElMessage.warning('请输入用户名和密码')
  return
}
```
- 确保用户名和密码不为空
- 租户编码可选

#### 步骤 2: 调用登录 API
```typescript
const result = await authAPI.login({
  username: username.value,
  password: password.value,
  tenant_code: selectedTenant.value
})
```
- 发送登录请求到后端
- 后端验证用户名和密码
- 返回 JWT Token

#### 步骤 3: 设置 Token
```typescript
tokenStore.setToken(token)
```
- 存储 Token 到 Token Store
- 自动持久化到 `localStorage.taihang-token`

#### 步骤 4: 并行获取用户数据
```typescript
const [userInfoResult, permissionsResult, menuTreeResult] = await Promise.all([
  authAPI.getUserInfo(),
  authAPI.getPermissions(),
  authAPI.getMenuTree()
])
```
- 使用 `Promise.all` 并行请求
- 提高加载速度
- 三个请求独立，无依赖关系

#### 步骤 5-7: 设置用户数据
```typescript
// 用户信息
userInfoStore.setUserInfo({ ... })

// 权限列表
permissionsStore.setPermissions(perms)

// 菜单树
menusStore.setMenuTree(menu)
```
- 分别存储到对应的 Store
- 自动持久化到 localStorage

#### 步骤 8: 等待持久化
```typescript
await new Promise(resolve => setTimeout(resolve, 100))
```
- 确保 pinia-plugin-persistedstate 完成写入
- 避免跳转后数据未持久化

#### 步骤 9: 跳转目标页面
```typescript
const redirect = (route.query.redirect as string) || '/'
router.push(redirect)
```
- 优先跳转到重定向参数指定的页面
- 否则跳转到首页

---

## 4. 流程图

### 4.1 完整登录流程

```
┌─────────────────────────────────────────────────────────────────┐
│              用户输入用户名、密码、租户编码                          │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
                    ┌────────────────────────┐
                    │   表单验证             │
                    │   检查用户名密码       │
                    └────────────────────────┘
                             │
                    ┌────────┴────────┐
                    │                 │
                   通过               未通过
                    │                 │
                    ▼                 ▼
        ┌───────────────────┐   ┌──────────┐
        │ 调用登录 API      │   │ 显示警告  │
        │ POST /api/v1/login│   │ 终止流程  │
        └───────────────────┘   └──────────┘
                    │
                    ▼
        ┌───────────────────────────┐
        │ 返回 JWT Token            │
        │ { token: "eyJhbGc..." }  │
        └───────────────────────────┘
                    │
        ┌───────────┴────────────────────────────────────┐
        │                                                │
        ▼                                                ▼
┌──────────────────┐                    ┌──────────────────────────┐
│ 设置 Token       │                    │ Promise.all 并行请求      │
│ tokenStore.      │                    │ ├─ getUserInfo()         │
│ setToken(token)  │                    │ ├─ getPermissions()      │
└──────────────────┘                    │ └─ getMenuTree()         │
        │                               └──────────────────────────┘
        │                                        │
        │       ┌────────────────────────────────┴────────┐
        │       │                                         │
        │       ▼                                         ▼
        │  ┌─────────────┐                      ┌──────────────┐
        │  │用户信息      │                      │权限列表      │
        │  │userInfoStore│                      │permissionsStore│
        │  └─────────────┘                      └──────────────┘
        │       │                                         │
        │       └────────────────┬────────────────────────┘
        │                        │
        │                        ▼
        │               ┌───────────────────┐
        │               │      菜单树         │
        │               │   menusStore.     │
        │               │   setMenuTree()    │
        │               └───────────────────┘
        │                        │
        └────────────────────────┴────────────────────────┐
                                                           │
                                                           ▼
                                               ┌────────────────────┐
                                               │ 等待持久化完成      │
                                               │ (~100ms)           │
                                               └────────────────────┘
                                                           │
                                                           ▼
                                               ┌────────────────────┐
                                               │ 跳转到目标页面      │
                                               │ router.push(redirect)│
                                               └────────────────────┘
```

### 4.2 数据存储流程

```
登录成功
    │
    ├─→ Token Store ───────────────────────────┐
    │       │                                  │
    │       ▼                                  ▼
    │   pinia-plugin-persistedstate        localStorage
    │       │                                  │
    │       ▼                                  ▼
    │   taihang-token = 'eyJhbGc...'
    │
    ├─→ UserInfo Store ────────────────────────┤
    │       │                                  │
    │       ▼                                  ▼
    │   pinia-plugin-persistedstate        localStorage
    │       │                                  │
    │       ▼                                  ▼
    │   taihang-user-info = {...}
    │
    ├─→ Permissions Store ─────────────────────┤
    │       │                                  │
    │       ▼                                  ▼
    │   pinia-plugin-persistedstate        localStorage
    │       │                                  │
    │       ▼                                  ▼
    │   taihang-permissions = [...]
    │
    └─→ Menus Store ──────────────────────────┤
            │                                  │
            ▼                                  ▼
        pinia-plugin-persistedstate        localStorage
            │                                  │
            ▼                                  ▼
        taihang-menus = {...}
```

---

## 5. 登出流程

### 5.1 登出代码实现

**文件**: 可在任意组件或 Composable 中实现

```typescript
import { useRouter } from 'vue-router'
import { useTokenStore, useUserInfoStore, usePermissionsStore, useMenusStore } from '@/stores'
import { resetAsyncRoutes } from '@/router'

const router = useRouter()

async function logout() {
  // 1. 清除所有 Store 数据
  const tokenStore = useTokenStore()
  const userInfoStore = useUserInfoStore()
  const permissionsStore = usePermissionsStore()
  const menusStore = useMenusStore()

  tokenStore.clearToken()           // 删除 taihang-token
  userInfoStore.clearUserInfo()     // 删除 taihang-user-info
  permissionsStore.clearPermissions() // 删除 taihang-permissions
  menusStore.clearMenuTree()         // 删除 taihang-menus

  // 2. 重置动态路由
  resetAsyncRoutes()

  // 3. 跳转到登录页
  router.push('/login')
}
```

### 5.2 登出流程图

```
用户点击登出按钮
       │
       ▼
┌────────────────────┐
│ 调用 logout()      │
└────────────────────┘
       │
       ├─→ Token Store.clearToken()
       │       │
       │       ▼
       │   删除 taihang-token
       │
       ├─→ UserInfo Store.clearUserInfo()
       │       │
       │       ▼
       │   删除 taihang-user-info
       │
       ├─→ Permissions Store.clearPermissions()
       │       │
       │       ▼
       │   删除 taihang-permissions
       │
       ├─→ Menus Store.clearMenuTree()
       │       │
       │       ▼
       │   删除 taihang-menus
       │
       ├─→ resetAsyncRoutes()
       │       │
       │       ▼
       │   清除动态路由
       │
       └─→ router.push('/login')
               │
               ▼
       ┌──────────────────┐
       │ 跳转到登录页      │
       └──────────────────┘
```

### 5.3 localStorage 变化

```
登出前:
├── taihang-token: 'eyJhbGciOi...'
├── taihang-user-info: '{"user_id":1,"user_name":"admin",...}'
├── taihang-permissions: '["monitor:realtime:page",...]'
└── taihang-menus: '[{"id":1,"menu_name":"监控预警",...}]'

登出后:
└── (全部为空或不存在)
```

---

## 6. 异常处理

### 6.1 常见错误场景

| 错误 | 处理方式 |
|-----|---------|
| **用户名或密码错误** | 显示错误提示，停留在登录页 |
| **网络错误** | 显示网络错误提示，停留在登录页 |
| **后端服务异常** | 显示服务异常提示，停留在登录页 |
| **Token 过期** | 自动跳转登录页（路由守卫处理） |

### 6.2 错误处理代码

```typescript
try {
  const result = await authAPI.login({ ... })

  if (result.code === 200) {
    // 登录成功
    tokenStore.setToken(result.data.token)
    // ...
  } else {
    // 登录失败（业务错误）
    ElMessage.error(result.message || '登录失败')
  }
} catch (error) {
  // 网络错误或异常
  if (error.response) {
    // 后端返回错误响应
    ElMessage.error(error.response.data?.message || '登录失败')
  } else if (error.request) {
    // 请求发送但无响应
    ElMessage.error('网络连接失败，请检查网络')
  } else {
    // 其他错误
    ElMessage.error('登录失败，请稍后重试')
  }
}
```

---

## 7. Token 管理

### 7.1 Token 格式

**JWT (JSON Web Token)** 格式：

```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoxLCJ1c2VybmFtZSI6ImFkbWluIiwiaWF0IjoxNjYwMDAwMDAwfQ.signature
└───────────────┬──────────────┘ └─────────────────┬─────────────────┘
       Header                          Payload
```

### 7.2 Token 使用

**请求拦截器** (Axios)：

```typescript
// src/api/auth/instance.ts
import axios from 'axios'
import { useTokenStore } from '@/stores'
import { ElMessage } from 'element-plus'

const authAxios = axios.create({
  baseURL: import.meta.env.VITE_API_BASE_URL,
  timeout: 10000
})

// 请求拦截器
authAxios.interceptors.request.use(
  (config) => {
    const tokenStore = useTokenStore()
    const token = tokenStore.token

    if (token) {
      config.headers.Authorization = `Bearer ${token}`
    }

    return config
  },
  (error) => {
    return Promise.reject(error)
  }
)

// 响应拦截器
authAxios.interceptors.response.use(
  (response) => response,
  (error) => {
    if (error.response?.status === 401) {
      // Token 过期或无效
      ElMessage.error('登录已过期，请重新登录')
      const tokenStore = useTokenStore()
      tokenStore.clearToken()
      window.location.href = '/login'
    }
    return Promise.reject(error)
  }
)

export default authAxios
```

---

**下一步**: 阅读 [动态路由系统](./04-动态路由系统.md) 了解路由如何根据菜单动态生成
